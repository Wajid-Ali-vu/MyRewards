<!DOCTYPE html>
<html lang="en">

<head>
  <title>Rewards Pro â€“ Management Suite</title>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fontawesome Files  -->
  <link rel="stylesheet" type="text/css" href="fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" type="text/css" href="fontawesome/css/solid.min.css">
  <link rel="stylesheet" type="text/css" href="fontawesome/css/regular.min.css">
  <link rel="stylesheet" type="text/css" href="fontawesome/css/brands.min.css">

  <!-- Add Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- <script src="chart.js"></script> -->
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --info: #06b6d4;
      --danger: #ef4444;
      --radius-lg: 20px;
      --radius-md: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    body.dark {
      --bg: #020617;
      --card-bg: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: #334155;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Plus Jakarta Sans", sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      transition: all 0.3s ease;
      line-height: 1.5;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
    }

    /* Header */
    .header {
      margin-bottom: 32px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: space-between;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 30px;
    }

    .logo-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      border-radius: 10px;
    }

    .logo-text h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 800;
    }

    .date-badge {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    /* Status Pills */
    .status-pill {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      background: var(--border);
      color: var(--text-muted);
    }

    .status-pill.online {
      background: #dcfce7;
      color: #166534;
    }

    .status-pill.local {
      background: #fef9c3;
      color: #854d0e;
    }

    /* User Nav */
    .user-nav {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      gap: 30px;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      background: var(--primary-light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      color: white;
    }

    .profile-details {
      display: flex;
      flex-direction: column;
    }

    .user-email {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .sync-status {
      font-size: 0.7rem;
      color: var(--success);
      font-weight: 500;
    }

    /* Stats Area */
    .overview-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
      margin-top: 30px;
    }

    .stat-box {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .stat-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      display: block;
      font-size: 2rem;
      font-weight: 800;
      margin-top: 8px;
    }

    /* Section Header */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 800;
      margin: 0;
    }

    /* Grid */
    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 24px;
    }

    /* Card */
    .account {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      cursor: default;
    }

    .account.dragging {
      opacity: 0.5;
      transform: scale(1.02);
      cursor: grabbing;
    }

    .account:hover {
      border-color: var(--primary-light);
    }

    .account.is-done {
      border-color: var(--success);
      border-width: 2px;
      background: lawngreen;
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 3px;
    }

    .card-top .title_sub-handle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drag-handle {
      cursor: grab;
      padding: 4px;
      color: var(--text-muted);
      font-size: 1.2rem;
      margin-left: -4px;
      width: 0;
      opacity: 0;
      visibility: hidden;
      transition: 0.3s ease;
    }

    .account:hover .drag-handle {
      width: auto;
      opacity: 1;
      visibility: visible;
    }

    .account_title {
      margin: 0;
      cursor: pointer;
    }

    .account_title:hover {
      color: var(--primary);
    }

    .card-settings .card-settings-wraper {
      display: flex;
      gap: 6px;
    }

    .card-settings .dropdown-wrapper {
      position: relative;
    }

    .card-settings .dropdown-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      font-size: 1rem;
    }

    .card-settings .setting_delete {
      min-width: 100px;
      background: #ffffffce;
      padding: 8px 0;
      border-radius: 8px;
      box-shadow: 1px 1px 3px #dedede;
      display: flex;
      flex-direction: column;
    }

    .dropdown-wrapper .set-del-wrapper {
      position: absolute;
      z-index: 10;
      top: 0px;
      right: 0;
      min-width: 100px;
      background: transparent;
      padding-top: 40px;
      opacity: 0;
      pointer-events: none;
      transform: translateX(calc(100% + 20px));
      transition: 0.3s ease;
    }


    .dropdown-wrapper:hover .set-del-wrapper {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);

    }

    .card-settings .setting_delete {
      background: #ffffff;
      padding: 8px 0;
      border-radius: 8px;
      box-shadow: 1px 1px 3px #dedede;
      display: flex;
      flex-direction: column;
      position: relative;

    }

    .card-settings .setting_delete::before {
      content: "";
      position: absolute;
      top: -6px;
      right: 14px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #5092dfce;
    }


    .card-settings .card-settings-wraper .setting_delete .btns {
      width: 100%;
      border-radius: 0;
      border: none;
      border-bottom: 1px solid #999898c7;
      background: #fff0;
      padding: 10px 5px;
      transition: 0.3s ease;
      text-align: left;
      justify-content: left;
    }

    .card-settings .card-settings-wraper .setting_delete .btns:hover {
      background-color: var(--primary);
      color: #fff;
    }

    .card-settings .card-settings-wraper .setting_delete .btns.delete:hover {
      background-color: var(--danger);
    }

    .card-settings .card-settings-wraper .setting_delete .btns:last-child {
      border-bottom: none;
    }

    .alarm-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 4px;
      font-weight: 700;
      transition: 0.3s ease;
    }

    .account:hover .alarm-indicator {
      font-size: 0.7rem;
    }

    .next-q-box {
      background: var(--bg);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      border-left: 0px solid var(--primary);
      width: 0;
      overflow: hidden;
      padding: 8px 0px;
      transition: 0.5s ease;
    }

    .account:hover .next-q-box {
      width: auto;
      padding: 8px 16px;
      border-left-width: 4px;
    }

    .next-q-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 4px;
      letter-spacing: 0.05em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .next-q-text {
      font-size: 0.85rem;
      font-weight: 600;
      font-style: italic;
      color: var(--text-main);
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn-pc:focus,
    .btn-mob:focus {
      outline: 4px solid var(--primary-light);
      outline-offset: 2px;
      transform: scale(0.98);
    }

    .p-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    .p-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .p-track {
      flex: 1;
      height: 10px;
      background: var(--border);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .p-fill {
      height: 100%;
      transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .btn-adj {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--text-main);
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-adj:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-adj:active {
      transform: scale(0.9);
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.58);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: stretch;
      justify-content: flex-end;
      z-index: 1000;
      padding: 0;
      animation: fadeIn 0.2s ease;
    }

    .modal {
      background: var(--card-bg);
      width: min(520px, 100%);
      border-radius: 22px 0 0 22px;
      padding: 28px;
      box-shadow: -12px 0 35px rgb(0 0 0 / 0.18);
      max-height: 100vh;
      overflow-y: auto;
      height: 100vh;
      animation: slidePanel 0.22s ease;
      border-left: 1px solid var(--border);
    }

    @keyframes fadeIn {
      <<<<<<< HEAD from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slidePanel {
      from {
        transform: translateX(26px);
        opacity: 0.8;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }

      =======from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slidePanel {
      from {
        transform: translateX(26px);
        opacity: 0.8;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }

      >>>>>>>5dbe33416ae0c0b45d33f0266fead157b5ad3ed4
    }

    .auth-header,
    .settings-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo {
      font-size: 2.5rem;
      margin-bottom: 16px;
    }

    .auth-header h2,
    .settings-header h2 {
      font-size: 1.5rem;
      font-weight: 800;
      margin: 0 0 8px 0;
    }

    .auth-header p,
    .settings-header p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-main);
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group textarea {
      height: 130px;
    }

    .form-group input:focus {
      border-color: var(--primary);
      outline: none;
    }

    /* Settings Sections */
    .settings-section {
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 20px;
    }

    .settings-section h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 32px;
    }

    /* Buttons */
    button {
      cursor: pointer;
      border: none;
      font-family: inherit;
      font-weight: 700;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-radius: 14px;
      padding: 12px 24px;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text-main);
      border-radius: 10px;
      padding: 8px 16px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 8px;
    }

    .btn-ghost:hover {
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
      border-radius: 8px;
    }

    .btn-pc {
      background: #10b981;
      color: white;
      border-radius: 12px;
      font-size: 0.85rem;
      padding: 12px;
    }

    .btn-mob {
      background: #06b6d4;
      color: white;
      border-radius: 12px;
      font-size: 0.85rem;
      padding: 12px;
    }

    .btn-done-toggle {
      background: var(--border);
      color: var(--text-muted);
      border-radius: 12px;
      grid-column: span 2;
      padding: 10px;
      font-size: 0.8rem;
    }

    .is-done .btn-done-toggle {
      background: #dcfce7;
      color: #166534;
      font-weight: 800;
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 8px 16px;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      font-size: 1rem;
    }

    .btn-icon:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }


    .full-width {
      width: 100%;
    }

    .error-text {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 12px;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    .btn-icon-toggle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--card-bg);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    body.dark .icon-light {
      display: none;
    }

    body:not(.dark) .icon-dark {
      display: none;
    }

    .settings-section {
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 20px;
    }

    .settings-section h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* ---------- Account Details UI ---------- */
    .modal-lg {
      max-width: 760px;
    }

    .modal-header {
      padding-bottom: 10px;
    }

    .modal-header .details-account-close {
      padding: 0;
      background-color: transparent;
      border: none;
      outline: none;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
    }

    .modal-header .details-account-close i {
      font-size: 20px;
    }

    .modal-header .details-account-title {
      margin: 0;
    }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .details-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .details-card h3 {
      margin-top: 0;
      margin-bottom: 12px;
    }

    .details-content p {
      margin: 6px 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* Full details form */
    .details-form {
      display: grid;
      gap: 12px;
    }

    .full-details-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .full-details-title .full-details-close-account {
      padding: 0;
      background-color: transparent;
      border: none;
      outline: none;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
    }

    .full-details-title .full-details-close-account i {
      font-size: 20px;
      color: #6366f1;
    }

    .full-details-title .account-h2 {
      margin: 0;
      color: #6366f1;
    }

    .full-details-title .full-details-close-reward {
      padding: 0;
      background-color: transparent;
      border: none;
      outline: none;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
    }

    .full-details-title .full-details-close-reward i {
      font-size: 20px;
      color: #22c55e;
    }

    .full-details-title .reward-h2 {
      margin: 0;
      color: #22c55e;
    }

    .full-details-title .add-redeem-code-btn {
      line-height: 20px;
    }

    .redeem-form-action-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .close-redeem-form-btn {
      width: 40%;
      background-color: var(--danger);
    }

    .add-radeem-btn {
      width: 50%;
    }

    /* Redeem codes list */
    .redeem-list {
      /* display: grid;
      gap: 8px; */
    }

    .redeem-view {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto auto auto;
      gap: 8px;
      align-items: center;
      padding: 8px 8px 16px;
      border-radius: 8px;
      background: var(--bg-card);
      position: relative;
    }

    .redeem-edit {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto auto;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      background: var(--bg-card);
    }

    .redeem-item.used {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .redeem-status.used {
      color: var(--danger);
    }

    .redeem-status.unused {
      color: var(--success);
    }

    .search-pc-btn:focus {
      outline: 3px solid #22c55e;
      outline-offset: 2px;
    }

    span.redeem-date {
      position: absolute;
      bottom: -5px;
      left: 10px;
      font-size: 14px;
      color: var(--primary-dark);
      opacity: 0;
      visibility: hidden;
      transition: 0.3s ease;
    }

    .redeem-view:hover span.redeem-date {
      opacity: 1;
      visibility: visible;
    }

    @media (max-width: 768px) {
      .overview-stats {
        grid-template-columns: 1fr;
      }

      .accounts-grid {
        grid-template-columns: 1fr;
      }

      .main-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
      }

      .header-right {
        width: 100%;
        justify-content: space-between;
      }

      .details-grid {
        grid-template-columns: 1fr;
      }

      .modal {
        width: 100%;
        border-radius: 0;
        height: 100vh;
      }
    }

    /* --- Filter Dashboard Styles --- */
    .filter-dashboard {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      background: var(--card-bg);
      padding: 15px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }

    /* --- Balance & Query Badges --- */
    .acc-balance {
      font-size: 0.75rem;
      color: var(--success);
      background: rgba(16, 185, 129, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 4px;
      display: inline-block;
      font-weight: 700;
    }

    .badge-count {
      background: var(--primary);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-right: 5px;
    }

    /* --- Suspended State --- */
    .account.suspended {
      opacity: 0.7;
      border-color: var(--text-muted);
      background: var(--bg);
    }

    .account.suspended .card-top .account_title {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    /* --- 1. Toast Notification Styles (Professional Alerts) --- */
    #toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: var(--card-bg);
      color: var(--text-main);
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      border-left: 5px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: auto;
      min-width: 250px;
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* --- 2. Redeem List Layout Fixes (Prevents breaking) --- */
    .redeem-view {
      /* Update the grid columns to be safer */
      grid-template-columns: 1.5fr 0.8fr 0.8fr 1.2fr 0.8fr auto auto auto;
    }

    /* Add ellipsis (...) for long text */
    .redeem-view span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    /* Specific adjustment for phone/dates to not get too small */
    .redeem-phone,
    .redeem-date {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* --- Animation Effects --- */
    @keyframes pop {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.15);
      }

      100% {
        transform: scale(1);
      }
    }

    .animate-pop {
      animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Confetti Particles (Canvas will be injected) */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 99999;
    }

    /* --- Professional Data Table Styles --- */
    .data-table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      text-align: left;
    }

    .data-table th {
      background: var(--bg);
      padding: 14px 16px;
      font-weight: 700;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      color: var(--text-main);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background: var(--bg);
      /* Row Highlight on Hover */
    }

    /* Specific Cell Styling */
    .code-cell {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px dashed transparent;
    }

    .code-cell:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.15);
    }

    .money-cell {
      font-weight: 600;
      color: var(--text-main);
    }

    .balance-text {
      font-size: 0.85em;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .balance-positive {
      color: var(--success);
      font-weight: 700;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-badge.unused {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .status-badge.used {
      background: var(--border);
      color: var(--text-muted);
      text-decoration: line-through;
    }

    /* --- Segmented Filter Bar (Professional Look) --- */
    .filter-dashboard {
      display: inline-flex;
      background: var(--border);
      padding: 4px;
      border-radius: 12px;
      gap: 0;
      border: none;
      margin-bottom: 24px;
      flex-wrap: nowrap;
      overflow-x: auto;
      max-width: 100%;
    }

    .filter-btn {
      background: transparent;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.85rem;
      box-shadow: none;
      white-space: nowrap;
    }

    .filter-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      color: var(--text-main);
    }

    .filter-btn.active {
      background: var(--card-bg);
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .filter-count {
      background: rgba(0, 0, 0, 0.1);
      color: var(--text-muted);
      margin-left: 8px;
      font-size: 0.7rem;
    }

    .filter-btn.active .filter-count {
      background: var(--primary);
      color: white;
    }

    /* Custom Tag Buttons */
    .filter-btn.custom-tag {
      border: 1px dashed var(--primary);
      color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
      margin-left: 5px;
    }

    .filter-btn.custom-tag.active {
      background: var(--primary);
      color: white;
      border-style: solid;
    }

    /* Edit Row Styling */
    .edit-row {
      background: var(--bg);
    }

    .edit-row input {
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      width: 100%;
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr !important;
      }
    }

    /* --- Mobile Bottom Navigation --- */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      z-index: 900;
      justify-content: space-around;
      align-items: center;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 8px;
      width: 100%;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 1.2rem;
    }

    /* Mobile Adjustments */
    @media (max-width: 768px) {
      .bottom-nav {
        display: flex;
      }

      .app-shell {
        padding-bottom: 90px;
      }

      /* Make space for nav */
      .header-right #open-settings-btn,
      .header-right #login-nav-btn {
        display: none;
      }

      /* Hide duplicate buttons */
    }

    /* --- Activity Log Items --- */
    .log-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .log-time {
      font-family: monospace;
      color: var(--text-muted);
      font-size: 0.75rem;
      white-space: nowrap;
      margin-top: 2px;
    }

    .log-text {
      color: var(--text-main);
      line-height: 1.4;
    }

    /* --- Empty State Design --- */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      margin-top: 20px;
      grid-column: 1 / -1;
      /* Span all columns */
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.3;
    }


    /* --- PRO AUTO SEARCH UI --- */

    .auto-search-section {
      position: relative;
      width: 100%;
    }

    .auto-search-section .view-section {
      position: absolute;
      top: 0;
      left: 30px;
      margin-bottom: 20px;
      background-color: #fff;
      padding: 15px;
      width: calc(100% - 60px);
      border-radius: 10px;
      z-index: -1;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: 0.5s ease;
    }

    .auto-search-section.show-auto-search .view-section {
      opacity: 1;
      visibility: visible;
      pointer-events: all;
      z-index: 99;
      position: relative;
    }

    /* Layout & Grid */
    .auto-header-pro {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 25px;
    }

    .auto-header-pro h2 {
      font-size: 1.5rem;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auto-header-pro h2 span {
      font-size: 0.8rem;
      background: var(--primary);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      vertical-align: middle;
    }

    .auto-header-pro p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-left: 38px;
    }

    .auto-dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .auto-dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .pro-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    /* Config Section */
    .card-header h3 {
      margin: 0 0 20px 0;
      font-size: 1rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .input-wrapper label,
    .delay-slider-area label {
      display: block;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .input-wrapper input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-weight: 700;
      color: var(--text-main);
      transition: all 0.2s;
    }

    .input-wrapper input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }


    /* Toggle Switch */
    .toggle-selector {
      display: flex;
      background: var(--bg);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .toggle-selector input {
      display: none;
    }

    .toggle-selector label {
      flex: 1;
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      margin: 0;
      transition: all 0.2s;
    }

    .toggle-selector input:checked+label {
      background: var(--card-bg);
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Delay Inputs */
    .dual-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dual-input input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-main);
    }

    .dual-input .divider {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    /* Command Buttons */
    .command-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .cmd-btn {
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cmd-btn:active {
      transform: scale(0.96);
    }

    .cmd-btn.start {
      flex: 2;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 15px;
      font-size: 1.1rem;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .cmd-btn.start:hover {
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
      transform: translateY(-2px);
    }

    .cmd-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      filter: grayscale(1);
    }

    .secondary-cmds {
      display: flex;
      gap: 10px;
      flex: 1;
    }

    .cmd-btn.pause {
      flex: 1;
      background: #f59e0b;
      color: white;
      font-size: 1.2rem;
    }

    .cmd-btn.reset {
      flex: 1;
      background: var(--bg);
      color: var(--text-muted);
      border: 1px solid var(--border);
      font-size: 1.2rem;
    }

    .cmd-btn.reset:hover {
      color: var(--danger);
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 5px;
    }

    .mini-stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .mini-stat-card .icon-bg {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 3rem;
      opacity: 0.05;
      color: var(--text-main);
    }

    .mini-stat-card .lbl {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 4px;
    }

    .mini-stat-card .val {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--text-main);
    }

    .success-text {
      color: var(--success) !important;
    }

    /* Terminal & Progress */
    .progress-card {
      padding: 25px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .pro-progress-track {
      height: 14px;
      background: var(--bg);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .pro-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--info));
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .progress-meta {
      text-align: right;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .terminal-card {
      background: #1e293b;
      color: #e2e8f0;
      border: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 320px;
    }

    .terminal-header {
      background: #0f172a;
      padding: 12px 20px;
      font-size: 0.85rem;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #334155;
    }

    .term-dots {
      display: flex;
      gap: 6px;
    }

    .term-dots .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .dot.red {
      background: #ef4444;
    }

    .dot.yellow {
      background: #f59e0b;
    }

    .dot.green {
      background: #10b981;
    }

    .terminal-window {
      flex: 1;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .log-entry {
      padding-left: 10px;
      border-left: 2px solid #334155;
      line-height: 1.4;
      opacity: 0.8;
    }

    .log-entry.system {
      color: #94a3b8;
      border-color: transparent;
      font-style: italic;
    }

    .log-time {
      color: #64748b;
      margin-right: 8px;
      font-size: 0.7rem;
    }

    .log-success {
      border-left-color: #10b981;
      color: #a7f3d0;
      opacity: 1;
    }

    .log-error {
      border-left-color: #ef4444;
      color: #fca5a5;
      opacity: 1;
    }

    .current-term-display {
      background: #0f172a;
      padding: 12px 20px;
      border-top: 1px solid #334155;
      font-size: 0.85rem;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .term-label {
      color: #64748b;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.7rem;
    }

    .term-text {
      color: #38bdf8;
      font-family: monospace;
    }

    /* Status Badge */
    .status-badge {
      background: var(--bg);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #cbd5e1;
      border-radius: 50%;
      display: block;
    }

    /* Active States */
    body.running .status-dot {
      background: #10b981;
      box-shadow: 0 0 8px #10b981;
      animation: pulse 1.5s infinite;
    }

    body.running .status-badge {
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.3);
      background: rgba(16, 185, 129, 0.05);
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }

      100% {
        opacity: 1;
      }
    }

    /* --- PROFESSIONAL LEDGER STYLES (v3.0) --- */
    .ledger-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      padding: 12px;
      background: var(--bg);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .ledger-search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    .ledger-search-box input {
      padding-left: 36px !important;
      border-radius: 8px;
    }

    .ledger-search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    /* Filters */
    .ledger-filters {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      padding: 4px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .l-filter-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      background: transparent;
      border: none;
      white-space: nowrap;
    }

    .l-filter-btn.active {
      background: var(--primary);
      color: white;
    }

    /* Bulk Actions (Dropdown Style) */
    .bulk-actions-wrapper {
      position: relative;
      display: none;
    }

    .bulk-actions-wrapper.visible {
      display: block;
      animation: fadeIn 0.2s;
    }

    .bulk-btn {
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bulk-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 5px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      min-width: 140px;
      z-index: 20;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .bulk-actions-wrapper:hover .bulk-menu {
      display: flex;
    }

    .bulk-menu button {
      background: transparent;
      border: none;
      padding: 10px;
      text-align: left;
      font-size: 0.8rem;
      color: var(--text-main);
      width: 100%;
    }

    .bulk-menu button:hover {
      background: var(--bg);
    }

    .bulk-menu button.danger {
      color: var(--danger);
    }

    /* ROW LAYOUT */
    .ledger-row {
      display: grid;
      /* Chk | Code | Phone | Money | Status | Date | Menu */
      grid-template-columns: 30px 2fr 1.5fr 1fr 100px 100px 40px;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
      position: relative;
    }

    .ledger-row:hover {
      background: var(--bg);
    }

    .ledger-row:last-child {
      border-bottom: none;
    }

    /* Hover Visibility Logic */
    .checkbox-wrapper {
      opacity: 0;
      transition: opacity 0.1s;
      display: flex;
      justify-content: center;
    }

    .ledger-row:hover .checkbox-wrapper,
    .ledger-row.selected .checkbox-wrapper,
    .checkbox-wrapper.always-visible {
      opacity: 1;
    }

    .action-menu-wrapper {
      opacity: 0;
      transition: opacity 0.1s;
      display: flex;
      justify-content: flex-end;
      position: relative;
    }

    .ledger-row:hover .action-menu-wrapper,
    .action-menu-wrapper.active {
      opacity: 1;
    }

    /* 3-Dot Menu */
    .action-dots-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      border: none;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .action-dots-btn:hover {
      background: var(--border);
      color: var(--text-main);
    }

    .row-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      z-index: 50;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 120px;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .action-menu-wrapper.active .row-dropdown {
      display: flex;
    }

    .row-dropdown button {
      padding: 10px;
      text-align: left;
      background: transparent;
      border: none;
      font-size: 0.8rem;
      color: var(--text-main);
      width: 100%;
      gap: 8px;
    }

    .row-dropdown button:hover {
      background: var(--bg);
    }

    .row-dropdown button.delete-btn {
      color: var(--danger);
    }

    /* Editing Form (Improved) */
    .ledger-row.edit-mode {
      display: block;
      padding: 15px;
      border: 1px solid var(--primary);
      border-radius: 8px;
      background: var(--bg);
      margin: 5px 0;
    }

    .edit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .edit-field label {
      display: block;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .edit-field input,
    .edit-field select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }

    /* Other Cells */
    .code-cell {
      font-family: monospace;
      font-weight: 700;
      color: var(--primary);
      cursor: pointer;
    }

    .phone-text {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .money-cell {
      font-weight: 700;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
    }

    .status-badge.unused {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-badge.used {
      background: var(--border);
      color: var(--text-muted);
    }

    .status-badge.in-progress {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    /* Header Row for Select All */
    .ledger-header-row {
      display: grid;
      grid-template-columns: 30px 1fr;
      gap: 12px;
      padding: 8px 12px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      border-radius: 8px 8px 0 0;
    }

    @media (max-width: 768px) {
      .ledger-row {
        grid-template-columns: 30px 1fr 40px;
        grid-template-areas: "chk code menu" "chk details details";
        gap: 5px;
      }

      .checkbox-wrapper {
        grid-area: chk;
        opacity: 1;
      }

      /* Always show check on mobile */
      .code-cell-wrapper {
        grid-area: code;
      }

      .action-menu-wrapper {
        grid-area: menu;
        opacity: 1;
      }

      .details-wrapper {
        grid-area: details;
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .desktop-only {
        display: none;
      }
    }

    .loan-list {
      display: grid;
      gap: 10px;
      max-height: 280px;
      overflow: auto;
    }

    .loan-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 10px;
      padding: 12px;
      font-size: 0.85rem;
      line-height: 1.4;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
</head>

<body>

  <!-- Mobile Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="document.getElementById('home').scrollIntoView({behavior:'smooth'})">
      <i class="fa-solid fa-layer-group"></i>
      <span>Accounts</span>
    </button>
    <!-- Add this to your Sidebar Navigation -->
    <a href="#" class="nav-item" id="open-auto-search-view" onclick="window.openAutoSearchView()">
      <i class="fa-solid fa-robot"></i>
      <span>Auto Search</span>
    </a>
    <button class="nav-item" onclick="document.querySelector('.overview-stats').scrollIntoView({behavior:'smooth'})">
      <i class="fa-solid fa-chart-pie"></i>
      <span>Stats</span>
    </button>
    <button class="nav-item" onclick="window.openAccountModal()">
      <i class="fa-solid fa-circle-plus"
        style="font-size: 2.2rem; color: var(--primary); margin-top: -15px; background: var(--card-bg); border-radius: 50%;"></i>
    </button>
    <button class="nav-item" onclick="window.openSettings()">
      <i class="fa-solid fa-gear"></i>
      <span>Settings</span>
    </button>
    <button class="nav-item" onclick="window.openAuth()">
      <i class="fa-solid fa-cloud"></i>
      <span>Sync</span>
    </button>
  </nav>

  <!-- Auth Modal -->
  <div id="auth-overlay" class="modal-overlay hidden">
    <div class="modal auth-modal">
      <div class="auth-header">
        <div class="auth-logo">â˜ï¸</div>
        <h2 id="auth-title">Welcome Back</h2>
        <p id="auth-subtitle">Sign in to sync your rewards cloud</p>
      </div>
      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="email" placeholder="name@example.com" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
      </div>
      <button id="auth-action-btn" class="btn-primary full-width">Login to Account</button>
      <div class="auth-footer">
        <p id="auth-toggle-link" style="margin: 15px 0; cursor: pointer; text-align: center;">New user? Create an
          account</p>
        <div style="display: flex; justify-content: space-between;">
          <button class="btn-ghost" id="forgot-password-link">Forgot password</button>
          <button class="btn-ghost" id="close-auth-btn">Continue Offline</button>
        </div>
      </div>
      <p id="auth-error" class="error-text"></p>
    </div>
  </div>

  <!-- Settings Modal (Backup/Restore) -->
  <!-- 1. Add this Settings Modal after your existing modals -->
  <div id="settings-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 style="margin-top:0">Global Settings</h2>
      <div class="settings-section">
        <h3>â° Global Default Reminder</h3>
        <div class="form-group">
          <label>Default Time</label>
          <input type="time" id="global-reminder-time">
        </div>
        <button class="btn-secondary" id="save-global-reminder-btn" onclick="closeSettings()" style="width:100%">Update
          Global Time</button>
      </div>
      <div class="settings-section">
        <h3>ðŸ›¡ï¸ Data Backup</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <button class="btn-secondary" onclick="exportToJSON()">ðŸ“¤ Export</button>
          <button class="btn-secondary" onclick="document.getElementById('import-input').click()">ðŸ“¥ Import</button>
        </div>
        <input type="file" id="import-input" class="hidden" accept=".json" onchange="importFromJSON(event)">
      </div>
      <div style="margin-top:24px;">
        <button class="btn-primary" onclick="closeSettings()" style="width:100%">Close</button>
      </div>
    </div>
  </div>

  <!-- Account Editor Modal -->
  <div id="account-modal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-title">Account Details</h2>
        <p>Configure your search automation parameters</p>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Account Name</label>
          <input type="text" id="edit-name" placeholder="Primary Account">
        </div>
        <div class="form-group">
          <label>Subtitle / Category</label>
          <input type="text" id="edit-sub" placeholder="e.g. Daily Main">
        </div>

        <!-- ADD THIS NEW BLOCK HERE: -->
        <div class="form-group">
          <label>Tags (comma separated)</label>
          <input id="edit-tags" placeholder="e.g. Gaming, Office, Priority">
          <div class="label-hint">Use tags to create custom filter tabs on dashboard.</div>
        </div>
      </div>

      <div class="form-group">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
          <label style="margin-bottom:0;">Queries <span id="query-count-badge" class="badge-count">0</span></label>
          <button type="button" id="reset-progress-btn" class="btn-ghost btn-sm"
            style="padding:2px 8px; font-size:0.7rem; color:var(--primary);">
            <i class="fa-solid fa-rotate-left"></i> Reset Progress
          </button>
        </div>
        <textarea id="edit-queries" rows="6"
          placeholder="Latest tech news&#10;Healthy recipes&#10;Travel destinations..."></textarea>

        <!-- New Progress Status Text -->
        <div style="display:flex; justify-content:space-between; margin-top:6px;">
          <span class="label-hint">(Paste keywords, one per line)</span>
          <span id="query-progress-status" style="font-size:0.7rem; color:var(--text-muted); font-weight:600;">Status:
            Pending</span>
        </div>
      </div>


      <div class="form-group">
        <label>â° Set Reminder (Alarm)</label>
        <input type="time" id="edit-alarm">
        <div class="label-hint">If account is completed, alarm will not fire.</div>
      </div>

      <div class="modal-actions">
        <button class="btn-ghost" id="cancel-account-btn">Discard</button>
        <button class="btn-primary" id="save-account-btn">Confirm Changes</button>
      </div>
    </div>
  </div>


  <!-- Loan Manager Modal -->
  <div id="loan-manager-modal" class="modal-overlay hidden">
    <div class="modal modal-lg">
      <div class="settings-header" style="margin-bottom:20px; text-align:left;">
        <h2 style="margin:0">ðŸ’³ Loan Manager</h2>
        <p id="loan-manager-subtitle" style="margin:6px 0 0;">Track lending and borrowing for this account.</p>
      </div>
      <div class="settings-section" style="margin-top:0; padding-top:0; border-top:none;">
        <h3>New Loan Entry</h3>
        <div class="details-grid">
          <div class="form-group">
            <label>Counterparty Account</label>
            <select id="loan-counterparty-input"></select>
          </div>
          <div class="form-group">
            <label>Amount</label>
            <input type="number" id="loan-amount-input" min="1" placeholder="Enter amount">
          </div>
        </div>
        <div class="details-grid">
          <div class="form-group">
            <label>Repay in days</label>
            <input type="number" id="loan-days-input" min="1" placeholder="e.g., 7">
          </div>
          <div class="form-group">
            <label>Direction</label>
            <select id="loan-direction-input">
              <option value="borrowed">Borrowed</option>
              <option value="lent">Lent</option>
            </select>
          </div>
        </div>
        <button class="btn-primary" data-action="add-loan" style="width:100%">+ Save Loan</button>
      </div>
      <div class="settings-section">
        <h3>Open Loans</h3>
        <div id="loan-list" class="loan-list"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" data-action="close-loans">Close</button>
      </div>
    </div>
  </div>


  <!-- Account Details Overview Modal -->
  <div id="account-details-modal" class="modal-overlay hidden">
    <div class="modal modal-lg">
      <div class="modal-header">
        <button class="details-account-close" data-action="close-account-details">
          <i class="fa-solid fa-arrow-left-long"></i>
          <h2 id="details-account-title" class="details-account-title">Account Overview</h2>
        </button>
      </div>

      <div class="details-grid">
        <!-- Account Details Section -->
        <div class="details-card">
          <h3>ðŸ‘¤ Account Details</h3>
          <div id="account-basic-details" class="details-content">
            <!-- injected by JS -->
          </div>
          <button class="btn-secondary btn-sm" data-action="open-account-full">
            View Full Details
          </button>
        </div>

        <!-- Rewards Details Section -->
        <div class="details-card">
          <h3>ðŸŽ Rewards Details</h3>
          <div id="rewards-basic-details" class="details-content">
            <!-- injected by JS -->
          </div>
          <button class="btn-secondary btn-sm" data-action="open-rewards-details">
            View Full Details
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Full Account / Rewards Details Modal -->
  <div id="full-details-modal" class="modal-overlay hidden">
    <div class="modal modal-lg">
      <div class="modal-header">
        <div id="full-details-title" class="full-details-title">Details</div>
      </div>

      <div id="full-details-body" class="details-form">
        <!-- dynamic content injected via JS -->
      </div>

      <div class="modal-actions" id="details-action-btns">
        <button class="btn-primary" id="save-full-details-btn">Save Changes</button>
      </div>
    </div>
  </div>

  <div class="app-shell">
    <header class="header">
      <div class="main-header">
        <div class="header-left">
          <div class="logo-group">
            <div class="logo-icon">R</div>
            <div class="logo-text">
              <h1>Rewards Pro</h1>
              <span id="date" class="date-badge"></span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <button class="btn-ghost" id="login-nav-btn">ðŸ”’ Cloud Login</button>
          <div id="connection-status" class="status-pill">Local Mode</div>
          <button class="btn-ghost" id="open-settings-btn" onclick="window.openSettings()">âš™ï¸ Settings</button>
          <button class="btn-icon-toggle" id="theme-toggle-btn">
            <span class="icon-light">â˜€ï¸</span>
            <span class="icon-dark">ðŸŒ™</span>
          </button>
          <button class="btn-ghost" onclick="window.openAutoSearchView()">
            <i class="fa-solid fa-robot"></i>
            <span>Auto Search</span>
          </button>
        </div>
      </div>

      <nav id="user-bar" class="user-nav hidden">
        <div class="user-profile">
          <div class="avatar" id="user-initials">U</div>
          <div class="profile-details">
            <span class="user-email" id="user-email-display">user@example.com</span>
            <span class="sync-status">Cloud Sync Active</span>
          </div>
        </div>
        <button class="btn-secondary btn-sm" id="logout-btn">Sign Out</button>
      </nav>
    </header>

    <!-- AUTO SEARCH VIEW (Pro Command Center UI) -->
    <div id="auto-search-view" class="auto-search-section">
      <div class="view-section">
        <div class="auto-header-pro">
          <div>
            <h2 class="text-gradient"><i class="fa-solid fa-robot"></i> Search Bot <span>v2.0</span></h2>
            <p>Automated Rewards Engine</p>
          </div>
          <div class="status-badge-container">
            <button class="btn-ghost" onclick="window.closeAutoSearchView()">X</button>
            <span id="auto-status-badge" class="status-badge idle">
              <span class="status-dot"></span> <span id="auto-log-status">System Ready</span>
            </span>
          </div>
        </div>

        <div class="auto-dashboard-grid">

          <!-- LEFT COL: Config & Actions -->
          <div class="auto-col-left">

            <!-- Control Deck -->
            <div class="pro-card config-card">
              <div class="card-header">
                <h3><i class="fa-solid fa-sliders"></i> Configuration</h3>
              </div>

              <div class="config-grid">
                <!-- Target Counts -->
                <div class="input-wrapper">
                  <label><i class="fa-solid fa-bullseye"></i> Searches</label>
                  <input type="number" id="auto-search-count" value="30" min="1" max="60">
                </div>

                <!-- Platform Select -->
                <div class="input-wrapper">
                  <label><i class="fa-solid fa-desktop"></i> Platform</label>
                  <div class="toggle-selector">
                    <input type="radio" name="auto-search-type" id="auto-desktop-mode" value="desktop" checked>
                    <label for="auto-desktop-mode">PC</label>

                    <input type="radio" name="auto-search-type" id="auto-mobile-mode" value="mobile">
                    <label for="auto-mobile-mode">Mobile</label>
                  </div>
                </div>
              </div>

              <div class="delay-slider-area">
                <label><i class="fa-solid fa-stopwatch"></i> Delay Range (ms)</label>
                <div class="dual-input">
                  <input type="number" id="auto-min-delay" value="5000" placeholder="Min">
                  <span class="divider">to</span>
                  <input type="number" id="auto-max-delay" value="10000" placeholder="Max">
                </div>
              </div>

              <!-- Big Action Buttons -->
              <div class="command-buttons">
                <button id="auto-start-btn" class="cmd-btn start">
                  <i class="fa-solid fa-power-off"></i> <span>INITIATE</span>
                </button>
                <div class="secondary-cmds">
                  <button id="auto-pause-btn" class="cmd-btn pause" disabled>
                    <i class="fa-solid fa-pause"></i>
                  </button>
                  <button id="auto-reset-btn" class="cmd-btn reset">
                    <i class="fa-solid fa-rotate-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Live Stats Widgets -->
            <div class="stats-row">
              <div class="mini-stat-card">
                <i class="fa-solid fa-window-restore icon-bg"></i>
                <span class="lbl">Tabs</span>
                <span class="val" id="auto-active-windows">0</span>
              </div>
              <div class="mini-stat-card success-border">
                <i class="fa-solid fa-coins icon-bg"></i>
                <span class="lbl">Points</span>
                <span class="val success-text" id="auto-points-earned">0</span>
              </div>
              <div class="mini-stat-card">
                <i class="fa-solid fa-hourglass-half icon-bg"></i>
                <span class="lbl">Next</span>
                <span class="val" id="auto-time-remaining">0s</span>
              </div>
            </div>

          </div>

          <!-- RIGHT COL: Terminal & Progress -->
          <div class="auto-col-right">

            <!-- Progress Ring/Bar -->
            <div class="pro-card progress-card">
              <div class="progress-header">
                <span>Progress</span>
                <span id="auto-progress-percent">0%</span>
              </div>
              <div class="pro-progress-track">
                <div id="auto-progress-fill" class="pro-progress-fill" style="width: 0%"></div>
              </div>
              <div class="progress-meta">
                <span id="auto-progress-text">0 / 0 Completed</span>
              </div>
            </div>

            <!-- Live Terminal -->
            <div class="pro-card terminal-card">
              <div class="terminal-header">
                <span><i class="fa-solid fa-terminal"></i> Live Activity Log</span>
                <div class="term-dots">
                  <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
                </div>
              </div>
              <div class="terminal-window" id="auto-log-entries">
                <div class="log-entry system">System initialized... awaiting command.</div>
              </div>
              <div class="current-term-display">
                <span class="term-label">Query:</span>
                <span id="auto-next-term" class="term-text">...</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <main class="content-area" id="main-content">
      <section class="accounts-section">
        <div class="section-header">
          <h2>Your Accounts</h2>
          <button class="btn-primary btn-sm" id="add-account-btn">+ New Account</button>
        </div>
        <!-- Filter Dashboard -->
        <div id="filter-dashboard" class="filter-dashboard">
          <!-- Buttons injected by JS -->
        </div>
        <div id="accounts-container" class="accounts-grid">
          <!-- Rendered via JS -->
        </div>
      </section>


      <div class="overview-stats">
        <div class="stat-box">
          <span class="stat-label">Total Accounts</span>
          <span id="stat-total" class="stat-value">0</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Daily Progress</span>
          <span id="stat-completed" class="stat-value">0</span>
        </div>
        <div class="stat-box" id="total-amount-card">
          <span class="stat-label" id="total-amount-card-label">Active Protocol</span>
          <span id="total-amount-card-amount" class="stat-value">Standard</span>
        </div>
      </div>

      <!-- Add Chart Container -->

      <!-- Inside <main class="content-area">, after .overview-stats -->
      <div class="charts-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
        <div class="stat-box" style="display:flex; flex-direction:column; align-items:center;">
          <h3 class="stat-label" style="width:100%; margin-bottom:15px;">Wallet Composition</h3>
          <div style="height:200px; width:100%; position:relative;">
            <canvas id="balanceChart"></canvas>
          </div>
        </div>
        <div class="stat-box">
          <h3 class="stat-label" style="margin-bottom:15px;">Recent Activity</h3>
          <div id="activity-log"
            style="font-size:0.85rem; color:var(--text-muted); display:flex; flex-direction:column; gap:8px;">
            <!-- Activity items injected by JS -->
            <p>No recent activity recorded.</p>
          </div>
        </div>
      </div>

    </main>

    <footer class="app-footer">
      <div class="footer-note"
        style="text-align: center; margin-top: 40px; color: var(--text-muted); font-size: 0.8rem;">
        Rewards Manager v2.1 â€¢ Data Safety Enabled
      </div>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      onAuthStateChanged,
      signOut,
      signInWithCustomToken,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      onSnapshot,
      deleteDoc,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDiSNTF50jv3JtFyO2or_wH2wvKooRIQw8",
      authDomain: "myrewards-7b777.firebaseapp.com",
      projectId: "myrewards-7b777",
      storageBucket: "myrewards-7b777.firebasestorage.app",
      messagingSenderId: "435751610864",
      appId: "1:435751610864:web:0397a7ff1ea5d4b4229535",
      measurementId: "G-9B866N9PPM",
    };

    const appId = typeof __app_id !== "undefined" ? __app_id : "my-rewards-tracker";
    const initialToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;

    const pcTarget = 30;
    const mobileTarget = 20;
    // CHANGE THIS LINE:
    // const todayStr = new Date().toDateString(); 

    // TO THIS:
    const todayStr = new Date().toISOString().split('T')[0]; // Returns "2026-02-13"

    let accountsData = {};
    let accountOrder = [];

    let currentFilter = 'all'; // New: Track active filter
    let lastSearchId = null;   // Renamed from lastPcSearchId
    let lastSearchType = 'pc'; // New: Track 'pc' or 'mob'
    // Initialize Activity Log Variable
    let activityLog = JSON.parse(localStorage.getItem('rewards_activity_log') || '[]');

    window.accountsData = accountsData;
    window.accountOrder = accountOrder;
    // --- UI Helpers ---
    // 1. Updated Robust Clipboard Function
    window.copyToClipboard = (text) => {
      // Modern API (Preferred)
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text)
          .then(() => window.showToast(`Copied: ${text}`, 'success'))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    };

    function fallbackCopy(text) {
      // Legacy Fallback (for older browsers/contexts)
      const textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        window.showToast(`Copied: ${text}`, 'success');
      } catch (err) {
        window.showToast("Failed to copy", "error");
      }
      document.body.removeChild(textArea);
    }

    let activeEditId = null;
    let db, auth;
    let isOnline = false;
    let authMode = "login";
    let currentUser = null;

    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig);
    auth = getAuth(firebaseApp);
    db = getFirestore(firebaseApp);

    const initAuth = async () => {
      try {
        if (initialToken) await signInWithCustomToken(auth, initialToken);
      } catch (e) { console.error("Auth init failed", e); }
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        isOnline = true;
        document.getElementById("login-nav-btn").classList.add("hidden");
        document.getElementById("user-bar").classList.remove("hidden");
        updateConnectionUI("Cloud Active", "online", user.email);
        console.log("User logged in:", user.uid);
        startSync(); // âœ… start Firestore only after login
      } else {
        isOnline = false;
        document.getElementById("login-nav-btn").classList.remove("hidden");
        document.getElementById("user-bar").classList.add("hidden");
        updateConnectionUI("Not Logged In", "local", null);
        loadLocal();
        checkAlarms();
        console.log("User logged out");
      }
    });

    function updateConnectionUI(text, pillClass, email) {
      const status = document.getElementById("connection-status");
      if (status) {
        status.innerText = text;
        status.className = `status-pill ${pillClass}`;
      }
      if (email) {
        document.getElementById("user-email-display").innerText = email;
        document.getElementById("user-initials").innerText = email.charAt(0).toUpperCase();
      }
    }

    // (best place: after updateConnectionUI())
    function normalizeExtendedAccountData() {
      Object.values(accountsData).forEach(acc => {

        // Account Details
        if (!acc.accountDetails) {
          acc.accountDetails = {
            gmail: "",
            firstName: "",
            lastName: "",
            recoveryEmail: "",
            dOB: "",
            phoneNumbers: [],
            passwordHint: "",
            backupCodes: []
          };
        }

        // Rewards
        if (!acc.rewards) {
          acc.rewards = {
            redeemContactNo: "",
            redeemHistory: []
          };
        }

        acc.rewards.redeemHistory.forEach(r => {
          if (!r.status) r.status = "unused";
          if (!r.phone) r.phone = "";
          if (r.status === 'used') r.balance = 0;
        });

        if (!Array.isArray(acc.loans)) acc.loans = [];
      });
    }


    function loadLocal() {
      const saved = localStorage.getItem("rewards_v4_accounts");
      const savedOrder = localStorage.getItem("rewards_v4_order");
      accountsData = saved ? JSON.parse(saved) : {};
      accountOrder = savedOrder ? JSON.parse(savedOrder) : Object.keys(accountsData);
      normalizeExtendedAccountData();
      render();
    }

    function saveLocal() {
      localStorage.setItem("rewards_v4_accounts", JSON.stringify(accountsData));
      localStorage.setItem("rewards_v4_order", JSON.stringify(accountOrder));
    }

    function startSync() {
      if (!currentUser || !db) return;

      const colRef = collection(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts");
      const metaRef = doc(db, "artifacts", appId, "users", currentUser.uid, "metadata", "sorting");
      const logRef = doc(db, "artifacts", appId, "users", currentUser.uid, "metadata", "activity_log");

      onSnapshot(metaRef, (docSnap) => {
        if (docSnap.exists()) {
          accountOrder = docSnap.data().order || [];
          render();
        }
      }, (err) => console.error("Order Sync Error", err));

      // NEW: Listen for Activity Log changes
      onSnapshot(logRef, (docSnap) => {
        if (docSnap.exists()) {
          activityLog = docSnap.data().logs || [];
          renderActivityLog();
        }
      });

      onSnapshot(colRef, (snapshot) => {
        const newData = {};
        snapshot.forEach((docSnap) => { newData[docSnap.id] = docSnap.data(); });
        accountsData = newData;
        normalizeExtendedAccountData();
        const accountIds = Object.keys(newData);
        accountOrder = accountOrder.filter((id) => accountIds.includes(id));
        accountIds.forEach((id) => { if (!accountOrder.includes(id)) accountOrder.push(id); });
        render();
        checkAlarms();
      }, (err) => console.error("Account Sync Error", err));
    }

    async function saveOrder() {
      if (isOnline && currentUser && db) {
        await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "metadata", "sorting"), { order: accountOrder });
      } else {
        saveLocal();
      }
    }


    // Professional Notification System
    window.showToast = (message, type = 'info') => {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-circle-exclamation' : 'fa-info-circle'}"></i>
    <span>${message}</span>
  `;

      container.appendChild(toast);

      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    // --- Professional Confetti Engine ---
    window.fireConfetti = () => {
      const canvas = document.getElementById('confetti-canvas') || document.createElement('canvas');
      if (!canvas.id) {
        canvas.id = 'confetti-canvas';
        document.body.appendChild(canvas);
      }
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#6366f1', '#10b981', '#06b6d4', '#f59e0b', '#ec4899'];

      for (let i = 0; i < 100; i++) {
        particles.push({
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 20,
          vy: (Math.random() - 0.5) * 20,
          life: 1,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 8 + 4
        });
      }

      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;
        particles.forEach(p => {
          if (p.life > 0) {
            active = true;
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.5; // Gravity
            p.life -= 0.02;
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
          }
        });
        if (active) requestAnimationFrame(loop);
        else canvas.remove();
      }
      loop();
    };

    function render() {
      const container = document.getElementById("accounts-container");
      const dashboard = document.getElementById("filter-dashboard");
      if (!container) return;

      ensureValidFilter();
      container.innerHTML = "";

      let stats = { all: 0, active: 0, suspended: 0, pending: 0, done: 0, unusedMoney: 0, hasLoans: 0, totalBalanceAmount: 0, totalMoney: 0 };
      let filteredOrder = [];

      accountOrder.forEach((id) => {
        const acc = accountsData[id];
        if (!acc) return;

        if (typeof acc.suspended === 'undefined') acc.suspended = false;
        if (acc.lastDate !== todayStr) {
          acc.pc = 0; acc.mob = 0; acc.done = false; acc.lastDate = todayStr;
        }

        // Logic matched with getRewardsSummary
        const history = acc.rewards?.redeemHistory || [];
        const accBalance = history.reduce((sum, r) => {
          const amt = Number(r.amount) || 0;
          const rawBal = r.balance !== undefined && r.balance !== null ? Number(r.balance) : amt;
          const bal = r.status === "used" ? 0 : Math.max(0, Math.min(rawBal, amt));
          return sum + bal;
        }, 0);

        stats.totalBalanceAmount += accBalance;

        // NEW: Calculate Total History Value
        const accTotalValue = history.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);

        // Add to global stats (you need to initialize totalMoney: 0 in stats object)
        stats.totalMoney = (stats.totalMoney || 0) + accTotalValue;

        const autoCompleted = (Number(acc.pc) >= pcTarget && Number(acc.mob) >= mobileTarget);
        const isCompleted = !!acc.done || autoCompleted;
        const hasActiveLoans = (acc.loans || []).some(l => l.status === "Active");

        stats.all++;
        if (acc.suspended) stats.suspended++;
        else {
          stats.active++;
          if (isCompleted) stats.done++;
          else stats.pending++;
        }
        if (accBalance > 0) stats.unusedMoney++;
        if (hasActiveLoans) stats.hasLoans++;

        // Filter Logic
        let include = false;
        if (currentFilter === 'all') include = true;
        else if (currentFilter === 'suspended') include = acc.suspended;
        else if (currentFilter === 'active') include = !acc.suspended;
        else if (currentFilter === 'pending') include = !acc.suspended && !isCompleted;
        else if (currentFilter === 'done') include = !acc.suspended && isCompleted;
        else if (currentFilter === 'money') include = accBalance > 0;
        else if (currentFilter === 'loans') include = hasActiveLoans;
        // NEW: Check if currentFilter matches one of the account's tags
        else if (acc.tags && acc.tags.some(t => String(t).trim().toLowerCase() === String(currentFilter).trim().toLowerCase())) include = true;

        if (include) filteredOrder.push({ id, ...acc, accBalance, isCompleted, hasActiveLoans });
      });

      // Render Dashboard
      // 1. Collect all unique tags from accounts
      const allTags = new Set();
      Object.values(accountsData).forEach(acc => {
        if (acc.tags && Array.isArray(acc.tags)) {
          acc.tags.forEach(tag => allTags.add(tag.trim()));
        }
      });

      // 2. Build Standard Filters
      let filtersHtml = [
        { k: 'all', l: 'All' },
        { k: 'active', l: 'Active' },
        { k: 'suspended', l: 'Suspended' },
        { k: 'pending', l: 'Pending' },
        { k: 'done', l: 'Completed' },
        { k: 'money', l: 'Unused Money' },
        { k: 'loans', l: 'Has Loans' }
      ].map(f => {
        const countMap = {
          all: stats.all,
          active: stats.active,
          suspended: stats.suspended,
          pending: stats.pending,
          done: stats.done,
          money: stats.unusedMoney,
          loans: stats.hasLoans
        };
        return `<button class="filter-btn ${currentFilter === f.k ? 'active' : ''}" onclick="window.setFilter('${f.k}')">
                ${f.l} <span class="filter-count">${countMap[f.k] || 0}</span>
             </button>`;
      }).join('');

      // 3. Add Custom Tag Buttons
      allTags.forEach(tag => {
        if (!tag) return;
        const count = Object.values(accountsData).filter(a => a.tags && a.tags.includes(tag)).length;
        const safeTagText = String(tag).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
        const tagEncoded = encodeURIComponent(tag);
        filtersHtml += `<button class="filter-btn custom-tag ${currentFilter === tag ? 'active' : ''}" data-filter-tag="${tagEncoded}" style="border-style:dashed; border-color:var(--primary); color:var(--primary);">#${safeTagText} <span class="filter-count">${count}</span></button>`;
      });

      dashboard.innerHTML = filtersHtml;

      dashboard.querySelectorAll('[data-filter-tag]').forEach(btn => {
        btn.onclick = () => window.setFilter(decodeURIComponent(btn.dataset.filterTag || ''));
      });

      // Check for Empty State
      if (filteredOrder.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fa-solid fa-ghost"></i>
                <h3>No Accounts Found</h3>
                <p>Adjust filters or add a new account.</p>
            </div>`;
      }

      // Render Cards (Existing code follows...)
      filteredOrder.forEach((accObj) => {

        const { id, accBalance, isCompleted, hasActiveLoans, ...acc } = accObj;

        const pcP = Math.min((acc.pc / pcTarget) * 100, 100);
        const mobP = Math.min((acc.mob / mobileTarget) * 100, 100);
        const queries = acc.queries || [];
        // FIX: Match the logic in performSearch. 
        // If we passed the list length, show "Random" instead of looping the text.
        let nextQ = "No queries";
        if (queries.length > 0) {
          if ((acc.qindex || 0) < queries.length) {
            // Still in first sequential pass
            nextQ = queries[acc.qindex];
          } else {
            // Random mode active
            nextQ = "ðŸŽ² Random / Shuffle Mode";
          }
        }
        const qIdx = acc.qindex || 0;

        const card = document.createElement("div");
        card.className = `account ${isCompleted ? "is-done" : ""} ${acc.suspended ? "suspended" : ""}`;
        card.draggable = true;
        card.dataset.id = id;

        const balanceHtml = accBalance > 0
          ? `<div class="acc-balance">ðŸ’° Bal: ${accBalance}</div>`
          : '';

        card.innerHTML = `
        <div class="card-top">
          <div class="title_sub-handle">
            <div class="drag-handle">â ¿</div>
            <div>
              <h3 class="account_title" data-action="open-account-details" data-id="${id}">${acc.name}</h3>
              <span class="acc-sub">${acc.sub || "General Account"}</span>
              ${balanceHtml}
            </div>
          </div>
          <div class="card-settings">
            <div class="card-settings-wraper">
              <div class="done-btn-wraper">
                <button class="btn-done-toggle toggle-done-btn" data-id="${id}" data-val="${!isCompleted}">
                  ${isCompleted ? "âœ…" : "ðŸ”ƒ"}
                </button>
              </div>
              <div class="dropdown-wrapper">
                <button class="dropdown-btn">ðŸ”½</button>
                <div class="set-del-wrapper">
                  <div class="setting_delete">
                    <button class="btns" data-action="edit-account" data-id="${id}">âš™ï¸ Edit</button>
                    
                    <!-- ADD THIS LINE BELOW -->
                    <button class="btns" data-action="manage-queries" data-id="${id}">ðŸ“ Queries</button>
                    <!-- ADD THIS LINE ABOVE -->

                    <button class="btns" onclick="window.toggleField('${id}', 'suspended', ${!acc.suspended})">
                      ${acc.suspended ? "â–¶ï¸ Activate" : "â¸ Suspend"}
                    </button>
                    <button class="btns delete-btn delete" data-id="${id}">ðŸ—‘ï¸ Delete</button>
                  </div>
                </div>
              </div>
            </div>
            ${acc.alarm ? `<div class="alarm-indicator" data-action="edit-account" data-id="${id}">â° ${acc.alarm}</div>` : ''}
          </div>
        </div>
        <div class="next-q-box" style="${acc.suspended ? 'opacity:0.5' : ''}">
          <div class="next-q-label">Next Query</div>
          <div class="next-q-text"><span class="badge-count">${qIdx + 1}</span>"${nextQ}"</div>
        </div>
        <div class="next-q-box" style="width:auto; padding:8px 16px; border-left-width:4px; ${acc.suspended ? 'opacity:0.5' : ''}">
          <div class="next-q-label">Loan Summary</div>
          <div class="next-q-text">${hasActiveLoans ? 'Active loan records available. Tap Loans for full details.' : 'No active loans for this account.'}</div>
        </div>
        <div class="action-grid" style="${acc.suspended ? 'pointer-events:none; opacity:0.5' : ''}">
          <button class="btn-pc search-pc-btn" data-id="${id}">ðŸ’» PC Search</button>
          <button class="btn-mob search-mob-btn" data-id="${id}">ðŸ“± Mobile</button>
          <button class="btn-done-toggle" data-action="open-loans" data-id="${id}">ðŸ’³ Loans</button>
        </div>
        <div class="progress-group" style="${acc.suspended ? 'opacity:0.5' : ''}">
          <div class="p-label"><span>PC Terminal</span><span>${acc.pc}/${pcTarget}</span></div>
          <div class="p-row">
            <button class="btn-adj adj-pc-minus" data-id="${id}">âˆ’</button>
            <div class="p-track">
              <div class="p-fill" style="width:${pcP}%; background: var(--success)"></div>
            </div>
            <button class="btn-adj adj-pc-plus" data-id="${id}">+</button>
          </div>
          <div class="p-label"><span>Mobile Hub</span><span>${acc.mob}/${mobileTarget}</span></div>
          <div class="p-row">
            <button class="btn-adj adj-mob-minus" data-id="${id}">âˆ’</button>
            <div class="p-track">
              <div class="p-fill" style="width:${mobP}%; background: var(--info)"></div>
            </div>
            <button class="btn-adj adj-mob-plus" data-id="${id}">+</button>
          </div>
        </div>
        `;

        // Animation for Done toggle
        const toggleBtn = card.querySelector('.toggle-done-btn');
        if (isCompleted) toggleBtn.classList.add('animate-pop');

        // Click to animate confetti if just turned done
        toggleBtn.addEventListener('click', (e) => {
          if (!isCompleted) window.fireConfetti(); // Fire if turning true (state is currently false before toggle)
        });

        // Button Click Animation Handlers
        card.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', function () {
            this.classList.remove('animate-pop');
            void this.offsetWidth; // trigger reflow
            this.classList.add('animate-pop');
          });
        });

        // Drag Logic
        card.addEventListener("dragstart", () => card.classList.add("dragging"));
        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
          accountOrder = [...container.querySelectorAll(".account")].map(el => el.dataset.id);
          saveOrder();
        });
        container.appendChild(card);
      });

      if (!container.dataset.dragBound) {
        container.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = document.querySelector(".dragging");
          if (!dragging) return;
          const afterElement = getDragAfterElement(container, e.clientY);
          if (afterElement == null) container.appendChild(dragging);
          else container.insertBefore(dragging, afterElement);
        });
        container.dataset.dragBound = "1";
      }

      document.getElementById("stat-total").innerText = accountOrder.length;
      document.getElementById("stat-completed").innerText = stats.done;
      const dateEl = document.getElementById("date");
      if (dateEl) dateEl.innerText = new Date().toDateString();


      const label = document.getElementById("total-amount-card-label");
      const amount = document.getElementById("total-amount-card-amount");
      if (label) {
        label.innerText = "Total Wallet Balance";
      }
      if (amount) {
        amount.innerHTML = `<span style="color:var(--success)">
          ${stats?.totalBalanceAmount || 0}
        </span>`;
      }


      attachDynamicEvents();
      renderCharts(stats);
      renderActivityLog()
    }

    // Add JS to Render Chart and call it at the end of your render() function.

    let myChart = null;

    function renderCharts(stats) {
      const ctx = document.getElementById('balanceChart');
      if (!ctx) return;

      // Calculate percentages or raw values
      const usedMoney = Math.max(0, (stats.totalMoney || 0) - (stats.totalBalanceAmount || 0));

      // Destroy old chart if exists to prevent overlapping
      if (myChart) myChart.destroy();

      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Available Balance', 'Used/Redeemed'],
          datasets: [{
            data: [stats.totalBalanceAmount, usedMoney],
            backgroundColor: ['#10b981', '#cbd5e1'],
            borderWidth: 0,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: 'Plus Jakarta Sans' } } }
          },
          cutout: '70%'
        }
      });
    }

    // Add the Logging Functions
    // --- Logging ---
    window.logActivity = async (text) => {
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      // Update local array first (optimistic UI update)
      activityLog.unshift({ time, text });
      if (activityLog.length > 5) activityLog.pop();
      renderActivityLog();

      if (isOnline && currentUser) {
        // NEW: Save to Firebase
        try {
          await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "metadata", "activity_log"), {
            logs: activityLog
          });
        } catch (e) { console.error("Log sync failed", e); }
      } else {
        // Fallback to Local Storage
        localStorage.setItem('rewards_activity_log', JSON.stringify(activityLog));
      }
    };

    function renderActivityLog() {
      const container = document.getElementById('activity-log');
      if (!container) return;

      if (!activityLog.length) {
        container.innerHTML = '<p style="color:var(--text-muted); font-size:0.85rem;">No recent activity.</p>';
        return;
      }

      container.innerHTML = activityLog.map(log => `
        <div class="log-item">
            <span class="log-time">${log.time}</span>
            <span class="log-text">${log.text}</span>
        </div>
    `).join('');
    }

    // Add Filter Helper Function Add this function anywhere in your script
    window.setFilter = (filter) => {
      currentFilter = filter;
      render();
    };

    function ensureValidFilter() {
      const baseFilters = new Set(['all', 'active', 'suspended', 'pending', 'done', 'money', 'loans']);
      if (baseFilters.has(currentFilter)) return;

      const hasTag = Object.values(accountsData).some(acc =>
        (acc.tags || []).some(tag => String(tag).trim().toLowerCase() === String(currentFilter).trim().toLowerCase())
      );

      if (!hasTag) currentFilter = 'all';
    }

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll(".account:not(.dragging)")];
      return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, element: child };
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function attachDynamicEvents() {
      const bind = (selector, fn) => {
        document.querySelectorAll(selector).forEach(el => el.onclick = (e) => {
          e.stopPropagation();
          fn(el.dataset);
        });
      };
      bind(".delete-btn", (d) => window.deleteAccount(d.id));
      bind(".search-pc-btn", (d) => window.performSearch(d.id, "pc"));
      bind(".search-mob-btn", (d) => window.performSearch(d.id, "mob"));
      bind(".toggle-done-btn", (d) => window.toggleField(d.id, "done", d.val === "true"));
      bind(".adj-pc-plus", (d) => window.adjustScore(d.id, "pc", 1));
      bind(".adj-pc-minus", (d) => window.adjustScore(d.id, "pc", -1));
      bind(".adj-mob-plus", (d) => window.adjustScore(d.id, "mob", 1));
      bind(".adj-mob-minus", (d) => window.adjustScore(d.id, "mob", -1));
      // In attachDynamicEvents...
      bind(".search-pc-btn", (d) => {
        lastSearchId = d.id;
        lastSearchType = 'pc';
        window.performSearch(d.id, "pc");
      });
      bind(".search-mob-btn", (d) => {
        lastSearchId = d.id;
        lastSearchType = 'mob';
        window.performSearch(d.id, "mob");
      });
    }

    // removed onclick inline
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const action = btn.dataset.action;

      switch (action) {
        case "open-account-details":
          openAccountDetailsModal(btn.dataset.id);
          break;

        case "open-account-full":
          if (window.currentDetailsAccountId) {
            openFullAccountDetails(window.currentDetailsAccountId);
          }
          break;

        case "open-rewards-details":
          if (window.currentDetailsAccountId) {
            openRewardsDetails(window.currentDetailsAccountId);
          }
          break;

        case "close-account-details":
          closeAccountDetailsModal();
          break;

        case "close-full-details":
          closeFullDetails();
          break;

        case "open-redeem-form":
          openRedeemForm();
          break;

        case "close-redeem-form":
          closeRedeemForm();
          break;
        case "add-redeem": {
          const code = document.getElementById("redeem-code-input").value.trim();
          const amount = document.getElementById("redeem-amount-input").value;
          const balance = document.getElementById("redeem-balance-input").value;
          const phone = document.getElementById("redeem-phone-input").value.trim();
          const date = document.getElementById("redeem-date-input").value;
          const status = document.getElementById("redeem-status-input")?.value || "unused";

          if (!code || !amount || !date) {
            alert("All fields are required.");
            return;
          }

          const codes = code.split(/\s+/).filter(c => c.startsWith("GC-"));
          codes.forEach(c => {
            const acc = accountsData[window.currentDetailsAccountId];
            if (!acc.rewards) acc.rewards = { redeemHistory: [] };
            acc.rewards.redeemHistory.push({
              id: crypto.randomUUID(),
              code: c,
              amount: Number(amount),
              balance: status === 'used' ? 0 : Number(balance || amount),
              phone: phone,
              date: date,
              status: status
            });
          });

          if (isOnline && currentUser) syncAccountToCloud(window.currentDetailsAccountId); else saveLocal();

          window.showToast("Redeem card added!", "success"); // NEW TOAST

          // Clear inputs
          document.getElementById("redeem-code-input").value = "GC-";
          document.getElementById("redeem-amount-input").value = "";
          document.getElementById("redeem-balance-input").value = "";
          document.getElementById("redeem-phone-input").value = "";

          renderLedger(window.currentDetailsAccountId);
          render();
        }
          break;


        case "toggle-redeem": {
          const redeemId = btn.dataset.id;
          toggleRedeemStatus(window.currentDetailsAccountId, redeemId);
          break;
        }

        case "delete-redeem": {
          const redeemId = btn.dataset.id;
          deleteRedeemCode(window.currentDetailsAccountId, redeemId);
          break;
        }

        // ... In your existing document.addEventListener("click", ...) switch statement:
        case "edit-redeem": {
          const id = btn.dataset.id;
          document.getElementById(`view-${id}`).classList.add("hidden");
          document.getElementById(`edit-${id}`).classList.remove("hidden");
        }
          break;

        case "cancel-edit": {
          const id = btn.dataset.id;
          document.getElementById(`view-${id}`).classList.remove("hidden");
          document.getElementById(`edit-${id}`).classList.add("hidden");
        }
          break;

        case "save-redeem": {
          const id = btn.dataset.id;
          const editRow = document.getElementById(`edit-${id}`); // Target the row directly

          const code = editRow.querySelector(".edit-code").value.trim().toUpperCase();
          const amount = Number(editRow.querySelector(".edit-amount").value);
          const balance = Number(editRow.querySelector(".edit-balance").value);
          const phone = editRow.querySelector(".edit-phone").value.trim();
          const date = editRow.querySelector(".edit-date").value;

          // ... (rest of logic remains the same) ...
          const acc = accountsData[window.currentDetailsAccountId];
          const redeem = acc.rewards.redeemHistory.find(r => r.id === id);
          if (!redeem) return;

          redeem.code = code;
          redeem.amount = amount;
          redeem.balance = balance;
          redeem.phone = phone; // Ensure phone is saved
          redeem.date = date;

          saveLocal();
          syncAccountToCloud(window.currentDetailsAccountId);
          render();
          renderRedeemList(window.currentDetailsAccountId);
        }
          break;

        case "edit-account":
          openAccountModal(btn.dataset.id);
          break;

        // ADD THIS NEW CASE
        case "open-loans":
          openLoanManager(btn.dataset.id);
          break;

        case "close-loans":
          closeLoanManager();
          break;

        case "add-loan":
          addLoanEntry();
          break;

        case "mark-loan-paid":
          markLoanPaid(btn.dataset.id);
          break;

        case "delete-loan":
          deleteLoanEntry(btn.dataset.id);
          break;

        case "manage-queries":
          openAccountModal(btn.dataset.id);
          // Auto-focus the queries box
          setTimeout(() => {
            const qBox = document.getElementById("edit-queries");
            if (qBox) {
              qBox.focus();
              qBox.scrollTop = qBox.scrollHeight;
            }
          }, 100);
          break;
      }
    });


    // --- DATA SAFETY (BACKUP/RESTORE) ---
    window.exportToJSON = () => {
      const backup = {
        version: "2.1",
        timestamp: new Date().toISOString(),
        order: accountOrder,
        data: accountsData
      };
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `RewardsBackup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.importFromJSON = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          if (!imported.data || !imported.order) throw new Error("Invalid backup format.");

          if (!confirm("This will replace your current accounts. Continue?")) return;

          if (isOnline && currentUser) {
            // Bulk sync to Firestore
            const batch = writeBatch(db);
            // Delete current
            accountOrder.forEach(id => {
              batch.delete(doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id));
            });
            // Add new
            Object.entries(imported.data).forEach(([id, acc]) => {
              batch.set(doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id), acc);
            });
            // Update order
            batch.set(doc(db, "artifacts", appId, "users", currentUser.uid, "metadata", "sorting"), { order: imported.order });
            await batch.commit();
          } else {
            accountsData = imported.data;
            accountOrder = imported.order;
            saveLocal();
            render();
          }
          alert("Import successful!");
          window.closeSettings();
        } catch (err) {
          alert("Error importing: " + err.message);
        }
      };
      reader.readAsText(file);
    };

    // UI Logic
    window.openAccountModal = (id = null) => {
      activeEditId = id;
      const modal = document.getElementById("account-modal");
      const statusEl = document.getElementById("query-progress-status");

      if (id && accountsData[id]) {
        const acc = accountsData[id];
        document.getElementById("modal-title").innerText = "Update Account";
        document.getElementById("edit-name").value = accountsData[id].name;
        document.getElementById("edit-sub").value = accountsData[id].sub || "";
        // NEW: Load Tags
        document.getElementById("edit-tags").value = (acc.tags || []).join(", ");
        document.getElementById("edit-tags").value = (acc.tags || []).join(", ");
        document.getElementById("edit-queries").value = (accountsData[id].queries || []).join("\n");
        document.getElementById("edit-alarm").value = accountsData[id].alarm || "";

        // Progress Status Logic
        const qLen = (acc.queries || []).length;
        const qIdx = acc.qindex || 0;

        if (qLen === 0) {
          statusEl.innerText = "No queries added";
          statusEl.style.color = "var(--danger)";
        } else if (qIdx < qLen) {
          statusEl.innerText = `Sequential: ${qIdx + 1} / ${qLen}`;
          statusEl.style.color = "var(--primary)";
        } else {
          statusEl.innerText = "Mode: Random Shuffle ðŸŽ²";
          statusEl.style.color = "var(--success)";
        }

      } else {
        document.getElementById("modal-title").innerText = "Add New Account";
        document.getElementById("edit-name").value = "";
        document.getElementById("edit-sub").value = "";
        document.getElementById("edit-queries").value = "";
        statusEl.innerText = "New Account";
      }
      modal.classList.remove("hidden");

      // Update Badge Count
      const updateCount = () => {
        const v = document.getElementById("edit-queries").value;
        const total = v.split('\n').map(q => q.trim()).filter(Boolean).length;
        document.getElementById("query-count-badge").innerText = total;
      };
      document.getElementById("edit-queries").oninput = updateCount;
      updateCount();

      // Wire up Reset Button
      const resetBtn = document.getElementById("reset-progress-btn");
      resetBtn.dataset.resetPending = "false"; // Clear flag
      resetBtn.onclick = () => {
        if (activeEditId && confirm("Reset search progress to start?")) {
          resetBtn.dataset.resetPending = "true";
          statusEl.innerText = "Will reset on Save â†º";
          statusEl.style.color = "var(--warning)";
          window.showToast("Progress will be reset upon saving", "info");
        }
      };

    };

    // ACCOUNT DETAILS MODAL LOGIC
    window.currentDetailsAccountId = null;

    // * account detail logic start here * //
    function updateAccountBasicDetails(accountId) {
      const d = accountsData[accountId].accountDetails || {};

      document.getElementById("account-basic-details").innerHTML = `
    <p><strong>Email:</strong> ${d.gmail || "â€”"}</p>
    <p><strong>Name:</strong> ${(d.firstName || "")} ${(d.lastName || "")}</p>
    <p><strong>Recovery:</strong> ${d.recoveryEmail || "â€”"}</p>
  `;
    }

    function updateRewardsBasicDetails(accountId) {
      const s = getRewardsSummary(accountId);

      document.getElementById("rewards-basic-details").innerHTML = `
    <p><strong>Total:</strong> ${s.total}</p>
    <p><strong>Used:</strong> ${s.used}</p>
    <p><strong>Unused:</strong> ${s.unused}</p>
  `;
    }

    function openAccountDetailsModal(accountId) {
      const acc = accountsData[accountId];
      if (!acc) return;

      window.currentDetailsAccountId = accountId;

      document.getElementById("details-account-title").innerText = acc.name;

      updateAccountBasicDetails(accountId);
      updateRewardsBasicDetails(accountId);

      document.getElementById("account-details-modal").classList.remove("hidden");
    }


    document.getElementById("save-full-details-btn").addEventListener("click", () => {
      const accountId = window.currentDetailsAccountId;
      if (!accountId) return;

      const acc = accountsData[accountId];
      acc.accountDetails ||= {};

      document
        .querySelectorAll("#full-details-body [data-field]")
        .forEach(el => {
          acc.accountDetails[el.dataset.field] = el.value;
        });

      syncAccountToCloud(accountId);
      updateAccountBasicDetails(accountId);
      updateRewardsBasicDetails(accountId);

      document.getElementById("full-details-modal").classList.add("hidden");
    });


    // * account detail logic close here * //


    // Open Full Account Details
    window.openFullAccountDetails = function (accountId) {
      const acc = accountsData[accountId];
      if (!acc) return;

      document.getElementById("full-details-title").innerHTML = `
        <button class="full-details-close-account" data-action="close-full-details">
          <i class="fa-solid fa-arrow-left"></i>
          <h2 class="account-h2">Account Details</h2>
        </button>
      `;

      const d = acc.accountDetails || {};

      document.getElementById("full-details-body").innerHTML = `
        <div class="form-grid">
          <div class="form-group">
            <label>Gmail</label>
            <input value="${d.gmail || ""}" data-field="gmail">
          </div>
          <div class="form-group">
            <label>First Name</label>
            <input value="${d.firstName || ""}" data-field="firstName">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input value="${d.lastName || ""}" data-field="lastName">
          </div>
          <div class="form-group">
            <label>Recovery Email</label>
            <input value="${d.recoveryEmail || ""}" data-field="recoveryEmail">
          </div>
          <div class="form-group">
            <label>Birthday</label>
            <input type="date" value="${d.dOB || ""}" data-field="dOB">
          </div>
          <div class="form-group">
            <label>Phone Numbers</label>
            <input value="${d.phoneNumbers || ""}" data-field="phoneNumbers">
          </div>
          <div class="form-group">
            <label>Pass</label>
            <input value="${d.passwordHint || ""}" data-field="passwordHint">
          </div>
          <div class="form-group">
            <label>Backup Codes</label>
            <textarea data-field="backupCodes" >${d.backupCodes || ""}</textarea>
          </div>
        </div>
      `;

      document.getElementById("save-full-details-btn").onclick = () => {
        const inputs = document.querySelectorAll("#full-details-body input, #full-details-body textarea");
        const updated = {};
        inputs.forEach(i => updated[i.dataset.field] = i.value.trim());
        updateAccountDetails(accountId, updated);
        closeFullDetails();
      };

      document.getElementById("full-details-modal").classList.remove("hidden");
    };


    window.closeAccountDetailsModal = () => {
      document.getElementById("account-details-modal").classList.add("hidden");
    };


    // --- PROFESSIONAL LEDGER SYSTEM v3.1 (STABLE) ---
    let ledgerState = { filter: 'all', search: '', page: 1, perPage: 15, selected: new Set() };
    window.activeLedgerEditId = null;
    window.activeActionMenuId = null;

    // Global Click to Close Menus
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.action-menu-wrapper')) {
        if (window.activeActionMenuId) {
          window.activeActionMenuId = null;
          // Only re-render if the ledger is actually open
          if (document.getElementById("ledger-container")) {
            renderLedger(window.currentDetailsAccountId);
          }
        }
      }
    });

    window.toggleActionMenu = (id) => {
      window.activeActionMenuId = window.activeActionMenuId === id ? null : id;
      renderLedger(window.currentDetailsAccountId);
    };

    // 1. Open Ledger Modal
    window.openRewardsDetails = function (accountId) {
      ledgerState = { filter: 'all', search: '', page: 1, perPage: 15, selected: new Set() };
      const acc = accountsData[accountId];
      if (!acc) return;

      document.getElementById("full-details-title").innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
        <div style="display:flex; align-items:center; gap:10px;">
             <button class="btn-ghost" data-action="close-full-details"><i class="fa-solid fa-arrow-left"></i></button>
             <h2 class="reward-h2" style="margin:0; color:var(--success)">Rewards Ledger</h2>
        </div>
        <button class="btn-primary btn-sm" data-action="open-redeem-form"><i class="fa-solid fa-plus"></i> Add New</button>
      </div>`;

      // Inject HTML Structure FIRST
      document.getElementById("full-details-body").innerHTML = `
        <div class="ledger-toolbar">
            <div class="ledger-search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="ledger-search" placeholder="Search codes..." oninput="window.handleLedgerSearch(this.value)">
            </div>
            
            <div class="ledger-filters">
                <button class="l-filter-btn active" onclick="window.setLedgerFilter('all', this)">All</button>
                <button class="l-filter-btn" onclick="window.setLedgerFilter('unused', this)">Unused</button>
                <button class="l-filter-btn" onclick="window.setLedgerFilter('used', this)">Used</button>
                <button class="l-filter-btn" onclick="window.setLedgerFilter('in-progress', this)">Pending</button>
            </div>
            
            <div style="display:flex; align-items:center; gap:8px;">
                <label for="ledger-per-page" style="font-size:0.8rem; color:var(--text-muted); font-weight:600;">Rows:</label>
                <select id="ledger-per-page" onchange="window.handlePerPage(this.value)" style="padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main);">
                    <option value="15" ${ledgerState.perPage === 15 ? 'selected' : ''}>15</option>
                    <option value="30" ${ledgerState.perPage === 30 ? 'selected' : ''}>30</option>
                    <option value="50" ${ledgerState.perPage === 50 ? 'selected' : ''}>50</option>
                </select>
            </div>

            <div id="bulk-actions" class="bulk-actions-wrapper">
                <button class="bulk-btn">
                    <span>Actions (<span id="selected-count">0</span>)</span> <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div class="bulk-menu">
                    <button onclick="window.bulkAction('mark-used')"><i class="fa-solid fa-check"></i> Mark Used</button>
                    <button onclick="window.bulkAction('mark-unused')"><i class="fa-solid fa-rotate-left"></i> Mark Unused</button>
                    <button class="danger" onclick="window.bulkAction('delete')"><i class="fa-solid fa-trash"></i> Delete</button>
                </div>
            </div>
        </div>

        <div class="ledger-header-row">
            <div class="checkbox-wrapper always-visible">
                <input type="checkbox" id="select-all-chk" onchange="window.toggleSelectAll(this)">
            </div>
            <div>Select All</div>
        </div>

        <div id="ledger-container" style="min-height:300px; padding-bottom:20px;"></div>
        
        <div class="load-more-area hidden" id="load-more-area">
            <button class="btn-secondary" onclick="window.loadMoreLedger()"><i class="fa-solid fa-rotate"></i> Load More</button>
        </div>
        
        <!-- Add Form -->
        <div class="redeem-form hidden" id="redeem-form" style="background:var(--bg); padding:20px; border-radius:12px; margin-top:20px; border:1px solid var(--border);">
          <h3 style="margin-top:0">Add New Card</h3>
          <div class="form-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div class="form-group" style="grid-column: span 2"><label>Redeem Code</label><input id="redeem-code-input" class="redeem-code-input" placeholder="GC-XXXX-XXXX-XXXX" value="GC-"></div>
            <div class="form-group"><label>Total Value</label><input type="number" id="redeem-amount-input" min="0"></div>
            <div class="form-group"><label>Current Balance</label><input type="number" id="redeem-balance-input" min="0" placeholder="Optional"></div>
            <div class="form-group"><label>Linked Phone</label><input type="text" id="redeem-phone-input" placeholder="+1..."></div>
            <div class="form-group"><label>Date Issued</label><input type="date" id="redeem-date-input" value="${new Date().toISOString().split('T')[0]}"></div>
            <div class="form-group"><label>Status</label>
               <select id="redeem-status-input" style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--border);">
                  <option value="unused">Unused</option>
                  <option value="used">Used</option>
                  <option value="in-progress">In Progress</option>
               </select>
            </div>
          </div>
          <div class="redeem-form-action-btn" style="margin-top:20px; justify-content:flex-end; gap:10px; display:flex;">
            <button class="btn-ghost" data-action="close-redeem-form">Cancel</button>
            <button class="btn-primary" data-action="add-redeem">Save Entry</button>
           </div> 
        </div>
      `;

      initCodeFormatter();
      renderLedger(accountId);
      document.getElementById("full-details-modal").classList.remove("hidden");
    };

    // 2. Render Ledger (FIXED: Null Checks)
    window.renderLedger = function (accountId, append = false) {
      const acc = accountsData[accountId];
      // SAFETY CHECK: If modal is closed (container is null), STOP immediately.
      const container = document.getElementById("ledger-container");
      if (!acc || !container) return;

      let items = acc.rewards?.redeemHistory || [];

      // Filter
      if (ledgerState.filter !== 'all') items = items.filter(i => i.status === ledgerState.filter);
      if (ledgerState.search) {
        const term = ledgerState.search.toLowerCase();
        items = items.filter(i => i.code.toLowerCase().includes(term) || (i.phone && i.phone.toLowerCase().includes(term)));
      }

      // Sort & Page
      items.sort((a, b) => new Date(b.date) - new Date(a.date));
      const totalItems = items.length;
      const limit = ledgerState.page * ledgerState.perPage;
      const pagedItems = items.slice(0, limit);

      // Load More Visibility (Safe Access)
      const loadMoreBtn = document.getElementById("load-more-area");
      if (loadMoreBtn) {
        if (totalItems > limit) loadMoreBtn.classList.remove("hidden");
        else loadMoreBtn.classList.add("hidden");
      }

      let html = "";
      if (pagedItems.length === 0) {
        html = `<div style="text-align:center; padding:50px; color:var(--text-muted);"><p>No records found.</p></div>`;
      } else {
        let lastGroup = "";
        pagedItems.forEach(item => {
          const dateObj = new Date(item.date);
          const groupKey = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

          if (groupKey !== lastGroup) {
            html += `<div class="date-group-header"><span>${groupKey}</span></div>`;
            lastGroup = groupKey;
          }

          if (window.activeLedgerEditId === item.id) {
            // --- EDIT ROW (Fixed Interactions) ---
            html += `
                    <div class="ledger-row edit-mode" id="edit-${item.id}" onclick="event.stopPropagation()">
                        <div class="edit-grid">
                           <div class="edit-field"><label>Code</label><input id="e-code-${item.id}" value="${item.code}"></div>
                           <div class="edit-field"><label>Phone</label><input id="e-phone-${item.id}" value="${item.phone || ''}"></div>
                           <div class="edit-field"><label>Amount</label><input type="number" id="e-amt-${item.id}" value="${item.amount}"></div>
                           <div class="edit-field"><label>Balance</label><input type="number" id="e-bal-${item.id}" value="${item.balance !== undefined ? item.balance : item.amount}"></div>
                           <div class="edit-field"><label>Date</label><input type="date" id="e-date-${item.id}" value="${item.date}"></div>
                           <div class="edit-field"><label>Status</label>
                               <select id="e-status-${item.id}">
                                  <option value="unused" ${item.status === 'unused' ? 'selected' : ''}>Unused</option>
                                  <option value="used" ${item.status === 'used' ? 'selected' : ''}>Used</option>
                                  <option value="in-progress" ${item.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                               </select>
                           </div>
                        </div>
                        <div style="display:flex; justify-content:flex-end; gap:10px;">
                            <button class="btn-ghost btn-sm" onclick="window.cancelLedgerEdit()">Cancel</button>
                            <button class="btn-primary btn-sm" onclick="window.saveLedgerEdit('${item.id}')">Save Changes</button>
                        </div>
                    </div>`;
          } else {
            // --- VIEW ROW ---
            const isChecked = ledgerState.selected.has(item.id) ? 'checked' : '';
            const isSelected = ledgerState.selected.has(item.id) ? 'selected' : '';

            const amountValue = Number(item.amount) || 0;
            const rawBalance = item.status === 'used' ? 0 : (item.balance !== undefined ? Number(item.balance) : amountValue);
            const bal = Math.max(0, rawBalance);
            const usedValue = Math.max(0, amountValue - bal);

            const isMenuOpen = window.activeActionMenuId === item.id ? 'active' : '';

            html += `
                    <div class="ledger-row ${item.status} ${isSelected}" id="row-${item.id}">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="custom-checkbox" onchange="window.toggleLedgerSelect('${item.id}')" ${isChecked}>
                        </div>
                        
                        <div class="code-cell-wrapper" onclick="window.copyToClipboard('${item.code}')">
                            <span class="code-cell">${item.code}</span>
                        </div>

                        <div class="phone-cell-wrapper">
                            ${item.phone ? `<span class="phone-text"><i class="fa-solid fa-phone"></i> ${item.phone}</span>` : ''}
                        </div>

                        <div class="money-cell-wrapper">
                           <div class="money-cell">${amountValue}</div>
                            ${(usedValue > 0 || bal !== amountValue) ? `<div class="balance-label" style="color:${bal > 0 ? 'var(--success)' : 'var(--text-muted)'}">Used: ${usedValue} | Remain: ${bal}</div>` : ''}
                        </div>

                        <div class="status-cell-wrapper">
                            <span class="status-badge ${item.status}">${item.status.replace('-', ' ')}</span>
                        </div>

                        <div class="date-cell-wrapper desktop-only">
                            ${item.date}
                        </div>

                        <div class="action-menu-wrapper ${isMenuOpen}">
                            <button class="action-dots-btn" onclick="event.stopPropagation(); window.toggleActionMenu('${item.id}')">
                               <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                            <div class="row-dropdown">
                                <button onclick="window.enableLedgerEdit('${item.id}')"><i class="fa-solid fa-pen"></i> Edit</button>
                                <button onclick="window.toggleLedgerItemStatus('${item.id}')"><i class="fa-solid fa-repeat"></i> Toggle Used</button>
                                <button class="delete-btn" onclick="window.deleteSingleItem('${item.id}')"><i class="fa-solid fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    </div>`;
          }
        });
      }
      container.innerHTML = html;
      updateBulkUI();
    };

    // 3. Helpers
    window.handleLedgerSearch = (v) => { ledgerState.search = v; ledgerState.page = 1; renderLedger(window.currentDetailsAccountId); };
    window.setLedgerFilter = (f, btn) => {
      ledgerState.filter = f; ledgerState.page = 1;
      document.querySelectorAll('.l-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderLedger(window.currentDetailsAccountId);
    };
    window.handlePerPage = (v) => { ledgerState.perPage = parseInt(v); ledgerState.page = 1; renderLedger(window.currentDetailsAccountId); };
    window.loadMoreLedger = () => { ledgerState.page++; renderLedger(window.currentDetailsAccountId, true); };

    // Edit Functions
    window.enableLedgerEdit = (id) => { window.activeLedgerEditId = id; window.activeActionMenuId = null; renderLedger(window.currentDetailsAccountId); };
    window.cancelLedgerEdit = () => { window.activeLedgerEditId = null; renderLedger(window.currentDetailsAccountId); };

    window.saveLedgerEdit = (id) => {
      const acc = accountsData[window.currentDetailsAccountId];
      const item = acc.rewards.redeemHistory.find(i => i.id === id);
      if (item) {
        item.code = document.getElementById(`e-code-${id}`).value;
        item.phone = document.getElementById(`e-phone-${id}`).value;
        item.amount = Number(document.getElementById(`e-amt-${id}`).value);
        item.balance = Number(document.getElementById(`e-bal-${id}`).value);
        item.date = document.getElementById(`e-date-${id}`).value;
        item.status = document.getElementById(`e-status-${id}`).value;
        if (item.status === 'used') item.balance = 0;

        if (isOnline && currentUser) syncAccountToCloud(window.currentDetailsAccountId); else saveLocal();
        window.showToast("Updated successfully", "success");
        window.activeLedgerEditId = null;
        renderLedger(window.currentDetailsAccountId); render();
      }
    };

    window.toggleLedgerItemStatus = (id) => {
      const acc = accountsData[window.currentDetailsAccountId];
      const item = acc.rewards.redeemHistory.find(i => i.id === id);
      if (item) {
        item.status = item.status === 'used' ? 'unused' : 'used';
        if (item.status === 'used') item.balance = 0;
        else if ((Number(item.balance) || 0) === 0) item.balance = Number(item.amount) || 0;

        if (isOnline && currentUser) syncAccountToCloud(window.currentDetailsAccountId); else saveLocal();
        window.showToast(`Status changed to ${item.status}`, "info");
        window.activeActionMenuId = null;
        renderLedger(window.currentDetailsAccountId); render();
      }
    };

    window.deleteSingleItem = (id) => {
      const accId = window.currentDetailsAccountId;
      if (!confirm("Delete this item?")) return;
      accountsData[accId].rewards.redeemHistory = accountsData[accId].rewards.redeemHistory.filter(i => i.id !== id);
      if (isOnline && currentUser) syncAccountToCloud(accId); else saveLocal();
      window.showToast("Item deleted", "success");
      window.activeActionMenuId = null;
      renderLedger(accId); render();
    };

    // Bulk Functions
    window.toggleSelectAll = (chk) => {
      const acc = accountsData[window.currentDetailsAccountId];
      let items = acc.rewards?.redeemHistory || [];
      if (ledgerState.filter !== 'all') items = items.filter(i => i.status === ledgerState.filter);
      if (chk.checked) items.forEach(i => ledgerState.selected.add(i.id));
      else ledgerState.selected.clear();
      renderLedger(window.currentDetailsAccountId);
    };

    window.toggleLedgerSelect = (id) => {
      if (ledgerState.selected.has(id)) ledgerState.selected.delete(id); else ledgerState.selected.add(id);
      updateBulkUI();
    };

    function updateBulkUI() {
      const c = ledgerState.selected.size;
      const div = document.getElementById("bulk-actions");
      const countSpan = document.getElementById("selected-count");
      if (countSpan) countSpan.innerText = c > 0 ? c : '';
      if (div) { if (c > 0) div.classList.add("visible"); else div.classList.remove("visible"); }
    }

    window.bulkAction = (action) => {
      const accId = window.currentDetailsAccountId;
      const hist = accountsData[accId].rewards.redeemHistory;
      const count = ledgerState.selected.size;
      if (count === 0) return;
      if (!confirm(`Perform action on ${count} items?`)) return;

      if (action === 'delete') {
        accountsData[accId].rewards.redeemHistory = hist.filter(i => !ledgerState.selected.has(i.id));
      } else {
        hist.forEach(i => {
          if (ledgerState.selected.has(i.id)) {
            if (action === 'mark-used') {
              i.status = 'used';
              i.balance = 0;
            }
            if (action === 'mark-unused') {
              i.status = 'unused';
              if ((Number(i.balance) || 0) === 0) i.balance = Number(i.amount) || 0;
            }
          }
        });
      }

      if (isOnline && currentUser) syncAccountToCloud(accId); else saveLocal();
      window.showToast(`Updated ${count} items`, "success");
      ledgerState.selected.clear();
      renderLedger(accId); render();
    };

    // Add Form Helper Helpers
    window.openRedeemForm = () => {
      document.getElementById("redeem-form").classList.remove("hidden");
      document.getElementById("ledger-container").classList.add("hidden");
      // Hide other ledger parts if needed, usually container swap is enough or overlay
      // For this UI, hiding container + header row + toolbar makes sense
      document.querySelector(".ledger-toolbar").classList.add("hidden");
      document.querySelector(".ledger-header-row").classList.add("hidden");
    }
    window.closeRedeemForm = () => {
      document.getElementById("redeem-form").classList.add("hidden");
      document.getElementById("ledger-container").classList.remove("hidden");
      document.querySelector(".ledger-toolbar").classList.remove("hidden");
      document.querySelector(".ledger-header-row").classList.remove("hidden");
    }

    function initCodeFormatter() {
      document.querySelectorAll(".redeem-code-input").forEach(input => {
        input.addEventListener("input", () => {
          let v = input.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
          if (!v.startsWith("GC")) v = "GC";
          input.value = v.slice(0, 2) + (v.length > 2 ? "-" + v.slice(2, 6) : "") + (v.length > 6 ? "-" + v.slice(6, 10) : "") + (v.length > 10 ? "-" + v.slice(10, 14) : "");
        });
      });
    }

    window.closeFullDetails = () => document.getElementById("full-details-modal").classList.add("hidden");

    window.saveAccount = async () => {
      const name = document.getElementById("edit-name").value.trim();
      const sub = document.getElementById("edit-sub").value.trim();
      // NEW: Get Tags
      const tags = document.getElementById("edit-tags").value.split(',').map(t => t.trim()).filter(t => t);

      // Get raw string first to check change
      const rawQueries = document.getElementById("edit-queries").value;
      const queries = rawQueries.split("\n").map(q => q.trim()).filter(q => q);

      const alarm = document.getElementById("edit-alarm").value || "";
      if (!name) return alert("Name required.");

      const id = activeEditId || `acc_${Date.now()}`;
      const existing = accountsData[id] || { pc: 0, mob: 0, done: false, qindex: 0, lastDate: todayStr };

      // 1. Detect if queries changed
      const oldQueries = existing.queries || [];
      const isQueriesChanged = JSON.stringify(oldQueries) !== JSON.stringify(queries);

      // 2. Detect Manual Reset
      const isManualReset = document.getElementById("reset-progress-btn").dataset.resetPending === "true";

      let newQIndex = existing.qindex;

      if (isQueriesChanged) {
        newQIndex = 0;
        window.showToast("Queries updated: Progress reset", "info");
      } else if (isManualReset) {
        newQIndex = 0;
        window.showToast("Search progress reset", "success");
      }

      const updated = {
        ...existing,
        name,
        sub,
        tags,
        queries,
        alarm,
        lastDate: todayStr,
        qindex: newQIndex,
        loans: Array.isArray(existing.loans) ? existing.loans : []
      };
      if (isOnline && currentUser) {
        await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id), updated, { merge: true });
      } else {
        accountsData[id] = updated;
        if (!accountOrder.includes(id)) accountOrder.push(id);
        saveLocal();
      }

      window.logActivity(`${activeEditId ? 'Updated' : 'Created'} account: ${name}`);
      document.getElementById("account-modal").classList.add("hidden");
      render();
    };

    window.deleteAccount = async (id) => {
      if (!confirm("Delete this account?")) return;
      if (isOnline && currentUser) {
        await deleteDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id));
      } else {
        delete accountsData[id];
        accountOrder = accountOrder.filter(oid => oid !== id);
        saveLocal(); render();
      }
    };

    window.performSearch = async (id, type) => {
      const acc = accountsData[id];
      const queries = acc.queries || [];
      if (!queries.length) {
        window.showToast("No queries configured!", "error");
        return;
      }

      let query;

      // First full cycle â†’ sequential (no repeats)
      if ((acc.qindex || 0) < queries.length) {
        query = queries[acc.qindex];
      }
      // After full cycle â†’ random
      else {
        query = queries[Math.floor(Math.random() * queries.length)];
      }

      // 1. CLEANED: Use the helper we defined in Part A
      window.copyToClipboard(query);

      // 2. Log it
      window.logActivity(`Search (${type}) on ${acc.name}`);

      const updates = {
        qindex: (acc.qindex || 0) + 1,
        [type]: (acc[type] || 0) + 1,
        lastDate: todayStr
      };

      if (isOnline && currentUser) {
        await setDoc(
          doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id),
          updates,
          { merge: true }
        );
      } else {
        accountsData[id] = { ...acc, ...updates };
        saveLocal();
        render();
      }

      window.open(`https://www.bing.com/`, "_blank");
      // window.open(`https://www.bing.com/search?q=${encodeURIComponent(query)}`, "_blank");
    };

    window.toggleField = async (id, field, val) => {
      if (isOnline && currentUser) {
        await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id), { [field]: val }, { merge: true });
      } else {
        if (accountsData[id]) accountsData[id][field] = val;
        saveLocal(); render();
      }
    };

    window.adjustScore = (id, type, amount) => {
      const cur = accountsData[id] ? accountsData[id][type] || 0 : 0;
      window.toggleField(id, type, Math.max(0, cur + amount));
    };

    // Loan Manager
    window.currentLoanAccountId = null;

    function getAccountLoans(accountId) {
      const account = accountsData[accountId];
      if (!account) return [];
      if (!Array.isArray(account.loans)) account.loans = [];
      return account.loans;
    }

    function formatLoanDate(v) {
      return new Date(v).toLocaleDateString();
    }

    function openLoanManager(accountId) {
      const acc = accountsData[accountId];
      if (!acc) return;
      window.currentLoanAccountId = accountId;
      document.getElementById("loan-manager-subtitle").innerText = `Manage loans for ${acc.name}`;

      const select = document.getElementById("loan-counterparty-input");
      select.innerHTML = Object.keys(accountsData)
        .filter(id => id !== accountId)
        .map(id => `<option value="${id}">${accountsData[id].name}</option>`).join('');

      document.getElementById("loan-amount-input").value = '';
      document.getElementById("loan-days-input").value = '7';
      document.getElementById("loan-direction-input").value = 'borrowed';

      document.getElementById("loan-manager-modal").classList.remove("hidden");
    }

    function closeLoanManager() {
      document.getElementById("loan-manager-modal").classList.add("hidden");
      window.currentLoanAccountId = null;
    }

    function addLoanEntry() {
      const accountId = window.currentLoanAccountId;
      if (!accountId) return;

      const fromId = document.getElementById("loan-counterparty-input").value;
      const amount = Number(document.getElementById("loan-amount-input").value);
      const days = Number(document.getElementById("loan-days-input").value);
      const direction = document.getElementById("loan-direction-input").value;

      if (!fromId || !amount || amount <= 0 || !days || days <= 0) {
        window.showToast("Please enter valid loan details.", "error");
        return;
      }

      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + days);

      getAccountLoans(accountId).push({
        id: crypto.randomUUID(),
        from: fromId,
        amount,
        startDate: new Date().toISOString(),
        dueDate: dueDate.toISOString(),
        direction,
        status: "Active"
      });

      saveLocal();
      render();
      window.showToast("Loan saved successfully.", "success");
    }

    function markLoanPaid(loanId) {
      const accountId = window.currentLoanAccountId;
      if (!accountId) return;
      const loans = getAccountLoans(accountId);
      const loan = loans.find(l => l.id === loanId);
      if (!loan) return;
      loan.status = "Paid";
      saveLocal();
      render();
    }

    function deleteLoanEntry(loanId) {
      const accountId = window.currentLoanAccountId;
      if (!accountId) return;
      accountsData[accountId].loans = getAccountLoans(accountId).filter(l => l.id !== loanId);
      saveLocal();
      render();
    }

    function renderLoans(accountId) {
      const container = document.getElementById("loan-list");
      if (!container) return;
      const loans = getAccountLoans(accountId);
      if (!loans.length) {
        container.innerHTML = `<div style="color:var(--text-muted); font-size:.9rem;">No loans added yet.</div>`;
        return;
      }

      container.innerHTML = loans.map(loan => {
        const fromName = accountsData[loan.from]?.name || "Unknown";
        const isOverdue = loan.status === "Active" && new Date(loan.dueDate) < new Date();
        return `
          <div class="loan-card">
            <div><strong>${loan.direction === 'lent' ? 'Lent to' : 'Borrowed from'}:</strong> ${fromName}</div>
            <div><strong>Amount:</strong> ${loan.amount}</div>
            <div><strong>Due:</strong> ${formatLoanDate(loan.dueDate)}</div>
            <div><strong>Status:</strong> ${loan.status}${isOverdue ? ' (Overdue)' : ''}</div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              ${loan.status === 'Active' ? `<button class="btn-secondary btn-sm" data-action="mark-loan-paid" data-id="${loan.id}">Mark Paid</button>` : ''}
              <button class="btn-secondary btn-sm" data-action="delete-loan" data-id="${loan.id}">Delete</button>
            </div>
          </div>`;
      }).join('');
    }

    // CORRECTED REWARDS SUMMARY LOGIC
    function getRewardsSummary(accountId) {
      const history = accountsData[accountId].rewards?.redeemHistory || [];

      let total = 0, balance = 0;

      history.forEach(r => {
        const amt = Number(r.amount) || 0;

        // Use balance if it exists, otherwise fallback to amount if status is unused, else 0
        let bal = 0;
        if (r.balance !== undefined && r.balance !== null) {
          bal = Number(r.balance);
        } else {
          bal = amt;
        }
        bal = r.status === "used" ? 0 : Math.max(0, Math.min(bal, amt));

        total += amt;
        balance += bal;
      });

      // Used is simply Total - Remaining Balance
      const used = total - balance;

      return { total, used, unused: balance };
    }

    // ACCOUNT DETAILS UPDATE HELPER
    function updateAccountDetails(accountId, updated) {
      Object.assign(accountsData[accountId].accountDetails, updated);

      if (isOnline && currentUser) {
        setDoc(
          doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", accountId),
          accountsData[accountId],
          { merge: true }
        );
      } else {
        saveLocal();
      }
      render();
    }

    // Add this helper function
    async function syncAccountToCloud(accountId) {
      if (!isOnline || !currentUser) return;

      await setDoc(
        doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", accountId),
        accountsData[accountId],
        { merge: true }
      );
    }
    // Modal Toggles
    window.openAuth = () => document.getElementById("auth-overlay").classList.remove("hidden");
    window.closeAuth = () => document.getElementById("auth-overlay").classList.add("hidden");
    window.openSettings = () => document.getElementById("settings-modal").classList.remove("hidden");
    window.closeSettings = () => document.getElementById("settings-modal").classList.add("hidden");
    window.toggleDark = () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("dark", document.body.classList.contains("dark"));
    };

    // open auto search tool 
    window.openAutoSearchView = () => {
      document.getElementById("auto-search-view")
        .classList.add("show-auto-search");

      document.getElementById("main-content")
        .classList.add("hidden");
    };
    // close auto search tool 
    window.closeAutoSearchView = () => {
      document.getElementById("auto-search-view")
        .classList.remove("show-auto-search");

      document.getElementById("main-content")
        .classList.remove("hidden");
    };




    // Event Bindings
    document.getElementById("auth-action-btn").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("password").value;
      const errEl = document.getElementById("auth-error");
      try {
        if (authMode === "login") await signInWithEmailAndPassword(auth, email, pass);
        else await createUserWithEmailAndPassword(auth, email, pass);
        window.closeAuth();
      } catch (e) { errEl.innerText = e.message.replace("Firebase: ", ""); }
    };

    document.getElementById("auth-toggle-link").onclick = () => {
      authMode = authMode === "login" ? "signup" : "login";
      document.getElementById("auth-title").innerText = authMode === "login" ? "Welcome Back" : "Create Account";
      document.getElementById("auth-action-btn").innerText = authMode === "login" ? "Login to Account" : "Register Now";
    };

    document.getElementById("forgot-password-link").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Enter email first.");
      await sendPasswordResetEmail(auth, email);
      alert("Reset email sent.");
    };

    document.getElementById("add-account-btn").onclick = () => window.openAccountModal();
    document.getElementById("save-account-btn").onclick = () => window.saveAccount();
    document.getElementById("cancel-account-btn").onclick = () => document.getElementById("account-modal").classList.add("hidden");
    document.getElementById("login-nav-btn").onclick = () => window.openAuth();
    document.getElementById("close-auth-btn").onclick = () => window.closeAuth();
    document.getElementById("logout-btn").onclick = () => signOut(auth);
    document.getElementById("theme-toggle-btn").onclick = () => window.toggleDark();

    // Global modal UX: close on outside click and Escape key
    document.querySelectorAll('.modal-overlay').forEach((overlay) => {
      overlay.addEventListener('mousedown', (e) => {
        if (e.target === overlay) {
          overlay.classList.add('hidden');
          if (overlay.id === 'loan-manager-modal') window.currentLoanAccountId = null;
        }
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      const openOverlays = [...document.querySelectorAll('.modal-overlay:not(.hidden)')];
      if (!openOverlays.length) return;
      const topOverlay = openOverlays[openOverlays.length - 1];
      topOverlay.classList.add('hidden');
      if (topOverlay.id === 'loan-manager-modal') window.currentLoanAccountId = null;
    });

    if (localStorage.getItem("dark") === "true") document.body.classList.add("dark");

    // 1. THE ALARM ENGINE (Add this at the bottom of your script)
    // --- ALARM ENGINE ---
    let firedAlarms = new Set();

    function formatTimeHHMM(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function checkAlarms() {
      const now = new Date();
      const curTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

      Object.entries(accountsData).forEach(([id, acc]) => {
        if (!acc.alarm || acc.done) return;

        const alarmTime = formatTimeHHMM(acc.alarm);
        const key = id + alarmTime;

        if (alarmTime === curTime && !firedAlarms.has(key)) {
          if (Notification.permission === "granted") {
            new Notification("Rewards Pro", {
              body: `Time for ${acc.name} searches!`
            });
          }
          firedAlarms.add(key);
        }
      });
    }

    // Request notification permission once
    if (Notification.permission !== "granted") {
      Notification.requestPermission().then(p => {
        if (p === "granted") checkAlarms();
      });
    }

    // Run once immediately in case alarm matches now
    checkAlarms();

    setInterval(checkAlarms, 10000); // Check every 10s


    document.getElementById("save-global-reminder-btn").addEventListener("click", async () => {
      const time = document.getElementById("global-reminder-time").value;

      if (!time) {
        alert("Please select a time.");
        return;
      }

      // Apply only to accounts without alarm
      Object.values(accountsData).forEach(acc => {
        if (!acc.alarm) {
          acc.alarm = time;
        }
      });

      if (isOnline && currentUser) {
        // Sync to Firestore
        for (const id of accountOrder) {
          const acc = accountsData[id];
          await setDoc(
            doc(db, "artifacts", appId, "users", currentUser.uid, "rewards_accounts", id),
            acc,
            { merge: true }
          );
        }
      } else {
        saveLocal();
      }

      render();
      alert("Global reminder applied to accounts without alarms.");
    });

    // Updated Focus Logic (Tracks last used button type)
    window.addEventListener("focus", () => {
      if (!lastSearchId || !lastSearchType) return;

      requestAnimationFrame(() => {
        // Selects .search-pc-btn OR .search-mob-btn based on what was last clicked
        const btn = document.querySelector(
          `.search-${lastSearchType}-btn[data-id="${lastSearchId}"]`
        );
        btn?.focus();
      });
    });


    // ==========================================
    // AUTO-SEARCH ENGINE LOGIC
    // ==========================================
    const autoWordList = [
      "weather today", "news update", "best movies 2024", "how to cook pasta",
      "latest tech news", "local restaurants", "sports scores", "funny cat videos",
      "history of ancient rome", "learn javascript", "python tutorial",
      "diet tips", "workout routines", "stock market", "cryptocurrency prices",
      "space exploration", "artificial intelligence", "climate change",
      "electric cars", "best smartphones", "travel destinations", "cheap flights",
      "hotel deals", "online courses", "learning spanish", "music festivals",
      "new video games", "book recommendations", "healthy recipes", "yoga for beginners",
      "home workout", "meditation techniques", "gardening tips", "home decor ideas",
      "DIY projects", "car maintenance", "personal finance", "saving money",
      "investing for beginners", "credit card rewards", "mortgage rates",
      "real estate market", "job search tips", "resume writing", "interview prep",
      "leadership skills", "time management", "productivity hacks", "mental health",
      "stress relief", "mindfulness", "sleep hygiene", "nutrition facts",
      "vitamins and supplements", "fitness trackers", "smart home devices",
      "gaming consoles", "pc building", "software development", "web design",
      "graphic design", "photography tips", "video editing", "digital marketing",
      "social media trends", "SEO optimization", "content creation", "blogging tips",
      "podcast recommendations", "streaming services", "upcoming movies",
      "tv show reviews", "celebrity news", "fashion trends", "skincare routine",
      "makeup tutorials", "hair care tips", "mens grooming", "womens fashion",
      "streetwear", "sneaker releases", "sports highlights", "nba news",
      "nfl updates", "soccer matches", "tennis tournaments", "golf tips",
      "fishing gear", "camping equipment", "hiking trails", "national parks",
      "wildlife photography", "nature documentaries", "science discoveries"
    ];

    let autoIsRunning = false;
    let autoIsPaused = false;
    let autoCompletedCount = 0;
    let autoTotalCount = 0;
    let autoActiveWindowsCount = 0;
    let autoPoints = 0;
    let autoTimer;
    let autoCurrentTimeout;
    let autoOpenedWindows = [];

    // DOM Elements
    const autoStartBtn = document.getElementById('auto-start-btn');
    const autoPauseBtn = document.getElementById('auto-pause-btn');
    const autoResetBtn = document.getElementById('auto-reset-btn');
    const autoLogs = document.getElementById('auto-log-entries');
    const autoProgressBar = document.getElementById('auto-progress-fill');
    const autoProgressText = document.getElementById('auto-progress-text');
    const autoProgressPct = document.getElementById('auto-progress-percent');
    const autoStatusText = document.getElementById('auto-log-status');
    const autoNextTerm = document.getElementById('auto-next-term');

    function addAutoLog(message, type = "info") {
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
      div.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      autoLogs.appendChild(div);
      autoLogs.scrollTop = autoLogs.scrollHeight;
    }

    function updateAutoUI() {
      document.getElementById('auto-active-windows').innerText = autoActiveWindowsCount;
      document.getElementById('auto-points-earned').innerText = autoPoints;
      autoProgressText.innerText = `${autoCompletedCount}/${autoTotalCount} Searches`;

      let pct = autoTotalCount > 0 ? Math.round((autoCompletedCount / autoTotalCount) * 100) : 0;
      autoProgressBar.style.width = `${pct}%`;
      autoProgressPct.innerText = `${pct}%`;
    }

    function generateRandomTerm() {
      let term = autoWordList[Math.floor(Math.random() * autoWordList.length)];
      const randomChars = Math.random().toString(36).substring(2, 6);
      return `${term} ${randomChars}`;
    }

    async function performAutoSearch() {
      if (!autoIsRunning || autoIsPaused) return;

      if (autoCompletedCount >= autoTotalCount) {
        autoIsRunning = false;
        addAutoLog("All searches completed successfully!", "success");
        autoStatusText.innerText = "Completed";
        autoStartBtn.disabled = false;
        autoPauseBtn.disabled = true;
        autoNextTerm.innerText = "Done";
        return;
      }

      const term = generateRandomTerm();
      const isMobile = document.getElementById('auto-mobile-mode').checked;
      autoNextTerm.innerText = term;

      // Calculate delays
      const minD = parseInt(document.getElementById('auto-min-delay').value);
      const maxD = parseInt(document.getElementById('auto-max-delay').value);
      const delay = Math.floor(Math.random() * (maxD - minD + 1)) + minD;

      addAutoLog(`Searching for: "${term}"...`);

      // Generate a "Conversation ID" to look like a real session
      const cvid = Array.from({ length: 32 }, () => Math.floor(Math.random() * 16).toString(16)).join("");

      // Add standard tracking parameters (form=QBLH is standard search bar, sp=-1 means no spell check trigger)
      const url = `https://www.bing.com/search?q=${encodeURIComponent(term)}&form=QBLH&sp=-1&lq=0&cvid=${cvid}`;

      let target = isMobile ? '_blank' : '_blank'; // Depending on setup, might need specific headers for mobile

      try {
        let win = window.open(url, '_blank');
        if (win) {
          autoOpenedWindows.push(win);
          autoActiveWindowsCount++;
          updateAutoUI();

          // Schedule close
          setTimeout(() => {
            if (!win.closed) {
              win.close();
              autoActiveWindowsCount = Math.max(0, autoActiveWindowsCount - 1);
              autoPoints += (isMobile ? 3 : 5); // 3 pts mobile, 5 pts PC
              autoCompletedCount++;
              updateAutoUI();
              addAutoLog(`Search complete. Earned points.`, 'success');
            }
          }, delay * 0.8); // close slightly before next search
        } else {
          addAutoLog("Popup blocked! Please allow popups.", "error");
          autoIsRunning = false;
          autoStartBtn.disabled = false;
          return;
        }
      } catch (err) {
        addAutoLog("Error opening window: " + err.message, "error");
      }

      // Countdown logic for UI
      let timeRemaining = Math.ceil(delay / 1000);
      document.getElementById('auto-time-remaining').innerText = `${timeRemaining}s`;

      autoTimer = setInterval(() => {
        timeRemaining--;
        if (timeRemaining >= 0) document.getElementById('auto-time-remaining').innerText = `${timeRemaining}s`;
      }, 1000);

      autoCurrentTimeout = setTimeout(() => {
        clearInterval(autoTimer);
        performAutoSearch();
      }, delay);
    }

    // Button Listeners
    autoStartBtn.addEventListener('click', () => {
      autoTotalCount = parseInt(document.getElementById('auto-search-count').value);
      if (autoTotalCount <= 0) return alert("Please enter a valid number of searches.");

      if (autoCompletedCount >= autoTotalCount) {
        autoCompletedCount = 0;
        autoPoints = 0;
        autoLogs.innerHTML = "";
      }

      // Add this reminder
      if (document.getElementById('auto-mobile-mode').checked) {
        window.showToast("Remember to switch User-Agent to Mobile!", "info");
      }

      autoIsRunning = true;
      autoIsPaused = false;
      autoStartBtn.disabled = true;
      autoPauseBtn.disabled = false;
      document.body.classList.add('running'); // <--- ADD THIS
      autoStatusText.innerText = "Running...";
      addAutoLog("Started search sequence...", "info");

      performAutoSearch();
    });

    autoPauseBtn.addEventListener('click', () => {
      autoIsPaused = true;
      autoIsRunning = false;
      clearTimeout(autoCurrentTimeout);
      clearInterval(autoTimer);
      autoStartBtn.disabled = false;
      autoPauseBtn.disabled = true;
      document.body.classList.remove('running'); // <--- ADD THIS
      autoStatusText.innerText = "Paused";
      addAutoLog("Sequence paused.", "error");
    });

    autoResetBtn.addEventListener('click', () => {
      autoIsRunning = false;
      autoIsPaused = false;
      clearTimeout(autoCurrentTimeout);
      clearInterval(autoTimer);

      // Close windows
      autoOpenedWindows.forEach(win => { if (!win.closed) win.close(); });
      autoOpenedWindows = [];

      autoCompletedCount = 0;
      autoActiveWindowsCount = 0;
      autoPoints = 0;

      updateAutoUI();
      autoStartBtn.disabled = false;
      autoPauseBtn.disabled = true;
      autoLogs.innerHTML = "";
      document.getElementById('auto-time-remaining').innerText = "0s";
      autoNextTerm.innerText = "Ready to start";
      autoStatusText.innerText = "System Ready";
      addAutoLog("System reset complete.");
    });
  </script>
  <div id="toast-container"></div>
</body>

</html>